package org.opentestsystem.ap.migration.ttsmapper;

import org.apache.commons.lang3.StringUtils;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemImageResource;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;

import javax.xml.bind.JAXBElement;
import java.io.Serializable;
import java.util.List;
import java.util.Objects;
import java.util.Optional;

import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_EBSR;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_EQ;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_GI;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_HTQO;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_HTQS;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_MC;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_MI;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_MS;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_SA;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_STIM;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_TI;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_WER;

/**
 * Abstract class that is extended by each item type-specific mapper
 */
public abstract class TtsMapper {

    /**
     * Main function used to merge the ttsElementInfo data to the Item
     * @param dataStoreItem         The Item
     * @param ttsElementInfoList    The List of TtsElementInfo objects
     */
    public abstract void mergeEquationTTS(Item dataStoreItem, List<TtsElementInfo> ttsElementInfoList);

    /**
     * Main function that sets the TIMS tts attributes on the Html that is passed in
     * @param htmlContent           The Html rich text
     * @param language              The language
     * @param item                  The Item
     * @param ttsElementInfoList    The ttsElementInfo object
     * @return                      Updated Html
     */
    String updateTTSOnRichTextEquationImages(String htmlContent, String language, Item item, List<TtsElementInfo> ttsElementInfoList) {
        Document document = newDocument(htmlContent);
        ttsElementInfoList.forEach(ttsElementInfo -> {
            if (ttsElementInfo.getLanguage().equalsIgnoreCase(language) &&
                    StringUtils.isNotBlank(ttsElementInfo.getFileName())) {
                String timsFileName = getTimsFileName(ttsElementInfo);
                Optional<ItemImageResource> imageResource = item.getImages()
                        .getImageResources().stream()
                        .filter(resource -> resource.getProductionFile()
                                .getFileName().equalsIgnoreCase(timsFileName))
                        .findFirst();
                if (imageResource.isPresent()) {
                    String imageResourceId = imageResource.get().getId();
                    Element image = document.getElementsByAttributeValue("data-iat-image-resource-id", imageResourceId).first();
                    if (image != null) {
                        Element ttsElement = image.parent();
                        if (!ttsElement.nodeName().equalsIgnoreCase("span")) {
                            image.wrap("<span></span>");
                            ttsElement = image.parent();
                        }
                        // Remove TTS values from image
                        updateTTSTag(ttsElement, ttsElementInfo.getAudioShortDesc());
                    }
                }
            }
        });
        return document.body().html();
    }

    /**
     * Determines which properties will be looked at to find the image filenames used during the initial import
     * @param item                  The ItemRelease.Item used during the initial import
     * @param itemType              The itemType
     * @param ttsElementInfoList    The List of TtsElementInfo
     */
    public void updateFileNamesFromItem(ItemRelease.Item item, String itemType, List<TtsElementInfo> ttsElementInfoList) {
        switch (itemType.toLowerCase()) {
            case TYPE_EBSR:
                updateFileNamesFromStemQti(item, ttsElementInfoList);
                break;
            case TYPE_SA:
            case TYPE_WER:
                updateFileNamesFromStemRubricSampleList(item, ttsElementInfoList);
                break;
            case TYPE_EQ:
            case TYPE_GI:
            case TYPE_HTQO:
            case TYPE_HTQS:
            case TYPE_TI:
                updateFileNamesFromStemRubric(item, ttsElementInfoList);
                break;
            case TYPE_MC:
            case TYPE_MS:
                updateFileNamesFromStemRationaleListOptionList(item, ttsElementInfoList);
                break;
            case TYPE_MI:
                updateFileNamesFromStemQtiRubricList(item, ttsElementInfoList);
                break;
        }
    }

    /**
     * Sets the filename property of a TtsElementInfo object
     * @param richText              The Html content
     * @param ttsElementInfoList    The list of TtsElementInfo objects
     */
    void setFileNamesOnAccessElementInfoList(String richText, List<TtsElementInfo> ttsElementInfoList) {
        if (StringUtils.isNotBlank(richText)) {
            Document stemDoc = newDocument(richText);
            ttsElementInfoList.forEach(accessElementInfo -> {
                Element image = stemDoc.getElementById(accessElementInfo.getItsLinkIdentifierRef());
                if (Objects.nonNull(image)
                        && StringUtils.isBlank(accessElementInfo.getFileName())) {
                    accessElementInfo.setFileName(image.attr("src"));
                }
            });
        }
    }

    /**
     * Looks for image filenames on ItemRelease.Item that implement Stem and Qti
     * Used in Ebsr items
     * @param item                  The ItemRelease.Item
     * @param ttsElementInfoList    The List of ItemRelease.Item objects
     */
    private void updateFileNamesFromStemQti(ItemRelease.Item item, List<TtsElementInfo> ttsElementInfoList) {
        item.getContent().forEach(content -> {
            // Look for filenames on Stem
            setFileNamesOnAccessElementInfoList(content.getStem(), ttsElementInfoList);
            // Look for filenames on Qti
            setFileNamesOnAccessElementInfoList(content.getQti().getValue(), ttsElementInfoList);
        });
    }

    /**
     * Looks for image filenames on ItemRelease.Item that implement Stem, Rubric and SampleList
     * Used in Sa, Wer
     * @param item                  The ItemRelease.Item
     * @param ttsElementInfoList    The List of ItemRelease.Item objects
     */
    private void updateFileNamesFromStemRubricSampleList(ItemRelease.Item item, List<TtsElementInfo> ttsElementInfoList) {
        item.getContent().forEach(content -> {
            // Look for filenames on Stem
            setFileNamesOnAccessElementInfoList(content.getStem(), ttsElementInfoList);
            // Look for filenames on Rubric list
            if (Objects.nonNull(content.getRubriclist())) {
                for (Serializable element : content.getRubriclist().getContent()) {
                    JAXBElement jaxbElement = (JAXBElement) element;
                    if (jaxbElement.getName().toString().equalsIgnoreCase("rubric")) {
                        ItemRelease.Item.Content.Rubriclist.Rubric rubric =
                                (ItemRelease.Item.Content.Rubriclist.Rubric) jaxbElement.getValue();
                        setFileNamesOnAccessElementInfoList(rubric.getVal(), ttsElementInfoList);
                    } else if (jaxbElement.getName().toString().equals("samplelist")) {
                        ItemRelease.Item.Content.Rubriclist.Samplelist samplelist =
                                (ItemRelease.Item.Content.Rubriclist.Samplelist) jaxbElement.getValue();
                        for (ItemRelease.Item.Content.Rubriclist.Samplelist.Sample sample : samplelist.getSample()) {
                            if (StringUtils.isNotBlank(sample.getSamplecontent())) {
                                setFileNamesOnAccessElementInfoList(sample.getSamplecontent(), ttsElementInfoList);
                            }
                        }
                    }
                }
            }
        });
    }

    /**
     * Looks for image filenames on ItemRelease.Item that implement Stem and Rubric
     * Used in Eq, Gi, Htqo, Htqs, Ti
     * @param item                  The ItemRelease.Item
     * @param ttsElementInfoList    The List of ItemRelease.Item objects
     */
    private void updateFileNamesFromStemRubric(ItemRelease.Item item, List<TtsElementInfo> ttsElementInfoList) {
        item.getContent().forEach(content -> {
            // Look for filenames on Stem
            setFileNamesOnAccessElementInfoList(content.getStem(), ttsElementInfoList);
            // Look for filenames on Rubric list
            if (Objects.nonNull(content.getRubriclist())) {
                for (Serializable element : content.getRubriclist().getContent()) {
                    JAXBElement jaxbElement = (JAXBElement) element;
                    if (jaxbElement.getName().toString().equalsIgnoreCase("rubric")) {
                        ItemRelease.Item.Content.Rubriclist.Rubric rubric =
                                (ItemRelease.Item.Content.Rubriclist.Rubric) jaxbElement.getValue();
                        setFileNamesOnAccessElementInfoList(rubric.getVal(), ttsElementInfoList);
                    }
                }
            }
        });
    }

    /**
     * Looks for image filenames on ItemRelease.Item that implement Stem, RationaleList and OptionList
     * Used in Mc, Ms
     * @param item                  The ItemRelease.Item
     * @param ttsElementInfoList    The List of ItemRelease.Item objects
     */
    private void updateFileNamesFromStemRationaleListOptionList(ItemRelease.Item item, List<TtsElementInfo> ttsElementInfoList) {
        item.getContent().forEach(content -> {
            // Look for filenames on Stem
            setFileNamesOnAccessElementInfoList(content.getStem(), ttsElementInfoList);
            // Look for filenames in Rationale list
            if (Objects.nonNull(content.getRationaleoptlist())) {
                content.getRationaleoptlist().getRationale()
                        .forEach(rationale -> setFileNamesOnAccessElementInfoList(
                                rationale.getVal(), ttsElementInfoList));
            }
            // Look for filenames in Option List
            if (Objects.nonNull(content.getOptionlist())) {
                content.getOptionlist().getOption()
                        .forEach(option -> setFileNamesOnAccessElementInfoList(
                                option.getVal(), ttsElementInfoList));
            }
        });
    }

    /**
     * Looks for image filenames on ItemRelease.Item that implement Stem, Qti and Rubric
     * Used in Mi
     * @param item                  The ItemRelease.Item
     * @param ttsElementInfoList    The List of ItemRelease.Item objects
     */
    private void updateFileNamesFromStemQtiRubricList(ItemRelease.Item item, List<TtsElementInfo> ttsElementInfoList) {
        item.getContent().forEach(content -> {
            // Look for filenames on Stem
            setFileNamesOnAccessElementInfoList(content.getStem(), ttsElementInfoList);
            // Look for filenames on Qti
            setFileNamesOnAccessElementInfoList(content.getQti().getValue(), ttsElementInfoList);
            // Look for filenames on Rubric list
            if (Objects.nonNull(content.getRubriclist())) {
                for (Serializable element : content.getRubriclist().getContent()) {
                    JAXBElement jaxbElement = (JAXBElement) element;
                    if (jaxbElement.getName().toString().equalsIgnoreCase("rubric")) {
                        ItemRelease.Item.Content.Rubriclist.Rubric rubric =
                                (ItemRelease.Item.Content.Rubriclist.Rubric) jaxbElement.getValue();
                        setFileNamesOnAccessElementInfoList(rubric.getVal(), ttsElementInfoList);
                    }
                }
            }
        });
    }

    // ------------------------------------------------------------------------
    // Helper methods

    /**
     * Returns the TIMS filename for a given image. It applies the item renaming logic to the filename
     * @param ttsElementInfo    The ttsElementInfo object
     * @return                  The updated filename
     */
    private String getTimsFileName(TtsElementInfo ttsElementInfo) {
        return ttsElementInfo.getFileName().replace(
                ttsElementInfo.getItemReleaseId(),
                getImportId(ttsElementInfo.getItemReleaseId(),
                        ttsElementInfo.getItemReleaseType(),
                        ttsElementInfo.getItemReleaseBankKey())
        );
    }

    /**
     * Updates the Element to include the TIMS tts relates attributes
     * @param ttsTag    The TIMS <img> tag (element)
     * @param ttsValue  The TTS string
     */
    private void updateTTSTag(Element ttsTag, String ttsValue) {
        if (!ttsTag.hasClass("iat-text2speech")) {
            ttsTag.addClass("iat-text2speech");
        }
        ttsTag.attr("data-iat-tts", isNotBlank(ttsValue) ? ttsValue : "");
    }

    /**
     * Returs a new Jsoup.Document
     * @param modelContent      The Html
     * @return                  A new Jsoup.Document
     */
    private Document newDocument(String modelContent) {
        Document doc = Jsoup.parseBodyFragment(modelContent);
        doc.outputSettings(new Document.OutputSettings().prettyPrint(false));
        doc.outputSettings().syntax(Document.OutputSettings.Syntax.xml);
        return doc;
    }

    /**
     * Applies the itemId renaming logic.
     * @param itemReleaseId         The item id on the ItemRelease used on the initial import
     * @param itemReleaseType       The item type used on the initial import
     * @param itemReleaseBankKey    The bankkey used on the initial import
     * @return
     */
    private static String getImportId(String itemReleaseId,
                                      String itemReleaseType,
                                      String itemReleaseBankKey)  {
        String importId = "";
        if (TYPE_STIM.equalsIgnoreCase(itemReleaseType)) {
            if ("200".equalsIgnoreCase(itemReleaseBankKey)) {
                importId = "17" + StringUtils.leftPad(itemReleaseId, 4, "0");
            } else if ("187".equalsIgnoreCase(itemReleaseBankKey)) {
                importId = "17" + StringUtils.leftPad(itemReleaseId, 4, "0");
            }
        } else {
            if ("200".equalsIgnoreCase(itemReleaseBankKey)) {
                importId = itemReleaseId;
            } else if ("187".equalsIgnoreCase(itemReleaseBankKey)) {
                importId = "18" + StringUtils.leftPad(itemReleaseId, 4, "0");
            }
        }
        return importId;
    }

}
