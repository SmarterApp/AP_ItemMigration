package org.opentestsystem.ap.migration.ttsmapper;

import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.MiItem;
import org.opentestsystem.ap.common.model.content.MiItemContent;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.springframework.stereotype.Component;

import javax.xml.bind.JAXBElement;
import java.io.Serializable;
import java.util.List;

import static org.opentestsystem.ap.common.model.ItemConstants.ItemLanguage.LANG_ENU;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemLanguage.LANG_ESN;

@Component
public class MiTtsMapper extends TtsMapper {

    @Override
    public void mergeEquationTTS(Item dataStoreItem, List<TtsElementInfo> ttsElementInfoList) {
        MiItem item = (MiItem) dataStoreItem;

        setEquationTTS(item.getCore().getEn(), LANG_ENU, dataStoreItem, ttsElementInfoList);
        setEquationTTS(item.getTranslations().getEsp(), LANG_ESN, dataStoreItem, ttsElementInfoList);
    }

    @Override
    public void updateFileNamesFromItem(ItemRelease.Item item, List<TtsElementInfo> ttsElementInfoList) {
        item.getContent().forEach(content -> {
            // Look for filenames on Stem
            setFileNamesOnAccessElementInfoList(content.getStem(), ttsElementInfoList);
            // Look for filenames on Qti
            setFileNamesOnAccessElementInfoList(content.getQti().getValue(), ttsElementInfoList);
            // Look for filenames on Rubric list
            for (Serializable element : content.getRubriclist().getContent()) {
                JAXBElement jaxbElement = (JAXBElement) element;
                if (jaxbElement.getName().toString().equalsIgnoreCase("rubric")) {
                    ItemRelease.Item.Content.Rubriclist.Rubric rubric =
                            (ItemRelease.Item.Content.Rubriclist.Rubric) jaxbElement.getValue();
                    setFileNamesOnAccessElementInfoList(rubric.getVal(), ttsElementInfoList);
                }
            }
        });
    }

    private void setEquationTTS(MiItemContent itemContent, String language, Item dataStoreItem, List<TtsElementInfo> ttsElementInfoList) {
        itemContent.setPrompt(updateTTSOnEquationImages(
                itemContent.getPrompt(), language, dataStoreItem, ttsElementInfoList));


        itemContent.getTable().getColumns().forEach(column ->
                column.setLabel(updateTTSOnEquationImages(
                        column.getLabel(), language, dataStoreItem, ttsElementInfoList))
        );

        itemContent.getTable().getRows().forEach(row -> {
            row.getCells().forEach(cell -> {
                if (cell.getType().equals("label")) {
                    cell.setValue(updateTTSOnEquationImages(
                            (String) cell.getValue(), language, dataStoreItem, ttsElementInfoList));
                }
            });
        });
    }
}
