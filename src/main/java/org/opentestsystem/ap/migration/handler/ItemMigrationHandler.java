package org.opentestsystem.ap.migration.handler;

import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.common.client.GitClient;
import org.opentestsystem.ap.common.repository.ItemRepository;
import org.opentestsystem.ap.migration.config.AppProps;
import org.opentestsystem.ap.migration.config.ApplicationDependencyProvider;
import org.opentestsystem.ap.migration.migration.ItemPostMigration;
import org.opentestsystem.ap.migration.migration.MigrationFactory;
import org.opentestsystem.ap.migration.model.BranchInfo;
import org.opentestsystem.ap.migration.model.BranchResult;
import org.opentestsystem.ap.migration.model.ItemInfo;
import org.opentestsystem.ap.migration.model.ItemResult;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;
import java.util.function.Consumer;

import static org.apache.commons.collections4.ListUtils.emptyIfNull;

@Slf4j
@Component
public class ItemMigrationHandler {

    private final AppProps appProps;

    private final MigrationFactory migrationFactory;

    private final ItemRepository itemRepository;

    private final BranchMigrationHandler branchMigrationHandler;

    public ItemMigrationHandler(final ApplicationDependencyProvider dependencyProvider,
                                final MigrationFactory migrationFactory,
                                final BranchMigrationHandler branchMigrationHandler) {
        this.appProps = dependencyProvider.getAppProps();
        this.itemRepository = dependencyProvider.getItemRepository();
        this.migrationFactory = migrationFactory;
        this.branchMigrationHandler = branchMigrationHandler;
    }

    public ItemResult migrateItem(final ItemInfo itemInfo) {
        log.info("migrate item {}", itemInfo.getItemId());

        final ItemResult itemResult = new ItemResult(itemInfo.getItemId(), new ArrayList<>(32));

        final GitClient gitClient = itemRepository.cloneRemoteRepository(
            appProps.getSystemUser(), itemInfo.getItemId());

        try {
            final List<BranchInfo> branches = emptyIfNull(itemInfo.getBranches());
            branches.forEach(migrate(itemInfo, itemResult, gitClient));
            postMigrate(itemInfo, itemResult, gitClient);
        } finally {
            if (gitClient != null) {
                log.info("deleting local repository for item {}", itemInfo.getItemId());
                gitClient.deleteLocalRepo();
            }
        }
        return itemResult;
    }

    private Consumer<BranchInfo> migrate(final ItemInfo itemInfo,
                                         final ItemResult itemResult,
                                         final GitClient gitClient) {
        return branchInfo -> {
            BranchResult branchResult = new BranchResult(itemInfo.getItemId(), branchInfo.getBranchName());

            if (!branchInfo.isFailedToLoad()) {
                branchResult = branchMigrationHandler.migrateBranch(itemInfo, branchInfo, gitClient);
            } else {
                branchResult.setSuccess(false);
                branchResult.setMigrationError("BranchLoadError", branchInfo.getErrorMessage());
            }

            if (branchResult.isSuccess()) {
                itemResult.addSuccessfulBranchMigration(branchResult);
            } else {
                itemResult.addFailedBranchMigration(branchResult.getMigrationError());
            }
        };
    }

    private void postMigrate(ItemInfo itemInfo, ItemResult itemResult, GitClient gitClient) {
        if (appProps.isItemPostMigrationEnabled()) {
            log.info("Running post migration for item {}", itemInfo.getItemId());
            ItemPostMigration itemPostMigration = migrationFactory.getItemPostMigration();
            itemPostMigration.postMigrate(itemInfo, itemResult, gitClient);
        }
    }
}
