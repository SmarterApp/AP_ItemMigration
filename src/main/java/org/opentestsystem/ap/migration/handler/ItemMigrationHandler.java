package org.opentestsystem.ap.migration.handler;

import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.common.client.GitClient;
import org.opentestsystem.ap.common.repository.ItemRepository;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.model.BranchInfo;
import org.opentestsystem.ap.migration.model.BranchResult;
import org.opentestsystem.ap.migration.model.ItemInfo;
import org.opentestsystem.ap.migration.model.ItemResult;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;
import java.util.function.Consumer;

import static org.apache.commons.collections4.ListUtils.emptyIfNull;

@Slf4j
@Component
public class ItemMigrationHandler {

    private final ApplicationProperties applicationProperties;

    private final ItemRepository itemRepository;

    private final BranchMigrationHandler branchMigrationHandler;

    public ItemMigrationHandler(ApplicationProperties applicationProperties,
                                ItemRepository itemRepository,
                                BranchMigrationHandler branchMigrationHandler) {
        this.applicationProperties = applicationProperties;
        this.itemRepository = itemRepository;
        this.branchMigrationHandler = branchMigrationHandler;
    }

    public ItemResult migrateItem(final ItemInfo itemInfo) {
        log.info("migrateAndSave item {}", itemInfo.getItemId());

        final ItemResult itemResult = new ItemResult(itemInfo.getItemId(), new ArrayList<>(32));

        final GitClient gitClient = itemRepository.cloneRemoteRepository(
            applicationProperties.getSystemUser(), itemInfo.getItemId());

        try {
            final List<BranchInfo> branches = emptyIfNull(itemInfo.getBranches());
            branches.forEach(migrate(itemInfo, itemResult, gitClient));
        } finally {
            if (gitClient != null) {
                log.info("deleting local repository for item {}", itemInfo.getItemId());
                gitClient.deleteLocalRepo();
            }
        }
        return itemResult;
    }

    private Consumer<BranchInfo> migrate(final ItemInfo itemInfo,
                                         final ItemResult itemResult,
                                         final GitClient gitClient) {
        return branchInfo -> {
            BranchResult branchResult = new BranchResult(itemInfo.getItemId(), branchInfo.getBranchName());

            if (!branchInfo.isFailedToLoad()) {
                branchResult = branchMigrationHandler.migrateBranch(itemInfo, branchInfo, gitClient);
            } else {
                branchResult.setSuccess(false);
                branchResult.setMigrationError("BranchLoadError", branchInfo.getErrorMessage());
            }

            if (branchResult.isSuccess()) {
                itemResult.addSuccessfulBranchMigration(branchResult);
            } else {
                itemResult.addFailedBranchMigration(branchResult.getMigrationError());
            }
        };
    }
}
