package org.opentestsystem.ap.migration.migration;

import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.common.client.GitClient;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.migration.model.BranchInfo;
import org.opentestsystem.ap.migration.model.ItemInfo;
import org.opentestsystem.ap.migration.model.MigrationDefinition;
import org.opentestsystem.ap.migration.util.Util;
import org.springframework.stereotype.Component;

import static org.opentestsystem.ap.common.repository.RepositoryUtil.getModelFileName;

/**
 * Migrate all item statuses to Draft.
 */
@Slf4j
@Component
public class Migration1611 extends AbstractMigration {

    private static final String DRAFT_WORKFLOW_STATUS = "Draft";

    public Migration1611(final Util util) {
        super(util);
    }

    @Override
    protected void runMigration(final ItemInfo itemInfo,
                                final BranchInfo branchInfo,
                                final MigrationDefinition migration,
                                final GitClient gitClient) {
        final Item item = gitClient.readModelFile();

        // set workflow status
        item.getWorkflow().setWorkflowStatusCode(DRAFT_WORKFLOW_STATUS);

        // write new model file
        gitClient.writeModelFile(item);

        // stage model file
        gitClient.stageFiles(getModelFileName());
    }
}
