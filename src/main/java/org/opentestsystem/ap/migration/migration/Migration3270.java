package org.opentestsystem.ap.migration.migration;

import org.jsoup.nodes.Document;
import org.opentestsystem.ap.common.datastore.DataStoreAttachmentManager;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.common.datastore.DataStoreItemManager;
import org.opentestsystem.ap.common.datastore.DataStoreUtility;
import org.opentestsystem.ap.common.datastore.entity.ItemEntity;
import org.opentestsystem.ap.common.saaif.mapper.model.SkipMigration;
import org.opentestsystem.ap.common.saaif.transformer.MapperUtil;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.contentupdater.ContentUpdateCommand;
import org.opentestsystem.ap.migration.contentupdater.ContentUpdateCommandResult;
import org.opentestsystem.ap.migration.contentupdater.ContentUpdaterContext;
import org.opentestsystem.ap.migration.model.MigrationContext;
import org.opentestsystem.ap.migration.util.ApplicationDependencyProvider;
import org.springframework.stereotype.Component;

import java.util.concurrent.atomic.AtomicBoolean;

import static org.opentestsystem.ap.common.model.ModelConstants.ItemType.TYPE_TUT;

@Component
public class Migration3270 extends AbstractMigration {

    public static String TAG_MATH = "math";
    public static String TAG_MI = "mi";
    public static String ATTR_MATHVARIANT = "mathvariant";
    public static String ATTR_NORMAL = "normal";

    public Migration3270(ApplicationDependencyProvider applicationDependencyProvider,
                         ApplicationProperties applicationProperties,
                         DataStoreDataManager dataManager,
                         DataStoreItemManager dataStoreItemManager,
                         DataStoreUtility dataStoreUtility,
                         DataStoreAttachmentManager dataStoreAttachmentManager) {
        super(applicationDependencyProvider, applicationProperties, dataManager,
                dataStoreItemManager, dataStoreUtility, dataStoreAttachmentManager);
    }

    @Override
    protected ItemEntity migrateEntity(final ItemEntity itemEntity, final MigrationContext migrationContext) {
        if (TYPE_TUT.equals(itemEntity.getItemJson().getType()) || !itemEntity.getItemJson().isImported()) {
            throw new SkipMigration("Item %s is not an imported Assessment item", itemEntity.getItemId());
        }

        Migration3270Command migration3270Command = new Migration3270Command();
        ContentUpdaterContext updaterContext = migrateEntityContentWithCheck(itemEntity, migration3270Command);
        if (!updaterContext.isContentChanged()) {
            throw new SkipMigration("Item %s does not contain MathMl that requires updating", itemEntity.getItemId());
        }

        return updaterContext.getMigratedEntity();
    }

    public static class Migration3270Command extends ContentUpdateCommand {
        @Override
        public ContentUpdateCommandResult applyEnglishContentUpdate(String englishContentHtml) {
            AtomicBoolean contentChanged = new AtomicBoolean(false);
            final Document doc = newJsoupDocument(englishContentHtml);

            doc.getElementsByTag(TAG_MATH).forEach(math -> {
                math.getElementsByTag(TAG_MI).forEach(mi -> {
                    if (!mi.hasAttr(ATTR_MATHVARIANT) && mi.hasText()) {
                        mi.attr(ATTR_MATHVARIANT,ATTR_NORMAL);
                        contentChanged.set(true);
                    }
                });
            });
            // Important to remove new lines on mapped content
            return new ContentUpdateCommandResult(contentChanged.get(), MapperUtil.removeNewLine(doc.body().html()));
        }

        @Override
        public ContentUpdateCommandResult applyTranslatedContentUpdate(String language, String translatedContent, String englishContent) {
            return this.applyEnglishContentUpdate(translatedContent);
        }
    }
}
