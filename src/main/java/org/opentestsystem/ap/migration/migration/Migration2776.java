package org.opentestsystem.ap.migration.migration;

import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.opentestsystem.ap.common.datastore.DataStoreAttachmentManager;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.common.datastore.DataStoreUtility;
import org.opentestsystem.ap.common.datastore.entity.ItemEntity;
import org.opentestsystem.ap.common.management.ItemManagerEventProducer;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.saaif.transformer.MapperUtil;
import org.opentestsystem.ap.migration.ApplicationDependencyProvider;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.contentupdater.ContentUpdateCommand;
import org.opentestsystem.ap.migration.datastore.AbstractDataStoreMigration;
import org.opentestsystem.ap.migration.model.SkipMigration;
import org.opentestsystem.ap.migration.util.ImportFileUtil;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;


@Component
public class Migration2776 extends AbstractDataStoreMigration {

    private List<String> STYLE_BLACK_LIST = new ArrayList<>();

    public Migration2776(ApplicationDependencyProvider applicationDependencyProvider,
                         ApplicationProperties applicationProperties,
                         DataStoreDataManager dataManager,
                         ItemManagerEventProducer eventProducer,
                         DataStoreUtility dataStoreUtility,
                         DataStoreAttachmentManager dataStoreAttachmentManager) {
        super(applicationDependencyProvider, applicationProperties, dataManager, eventProducer, dataStoreUtility, dataStoreAttachmentManager);

        STYLE_BLACK_LIST.add("line-height:0.2402in;");
        STYLE_BLACK_LIST.add("color:#000000;");
        STYLE_BLACK_LIST.add("font-weight:bold;");
        STYLE_BLACK_LIST.add("font-style:normal;");
        STYLE_BLACK_LIST.add("font-weight:normal;");
        STYLE_BLACK_LIST.add("font-variant:normal;");
        STYLE_BLACK_LIST.add("text-transform:none;");
        STYLE_BLACK_LIST.add("background-color:transparent;");
    }

    @Override
    protected ItemEntity migrateEntity(ItemEntity itemEntity) {
        if (shouldMigrate(itemEntity)) {
            Migration2776Command migration2776Command = new Migration2776Command();
            return migrateEntityContent(contentUpdaterFactory, itemEntity, migration2776Command);
        } else {
            throw new SkipMigration(String.format("Item %s is not imported or a Tutorial. No updates necessary", itemEntity.getItemId()));
        }
    }

    public class Migration2776Command extends ContentUpdateCommand {
        @Override
        public String applyContentUpdate(String htmlContent) {
            final Document doc = newJsoupDocument(htmlContent);
            removeStyleValuesFromElement(doc, "p");
            removeStyleValuesFromElement(doc, "span");
            removeStyleValuesFromElement(doc, "sup");
            // Important to remove new lines on mapped content
            return MapperUtil.removeNewLine(doc.body().html());
        }
    }

    private boolean shouldMigrate(ItemEntity itemEntity) {
        boolean migrate = false;
        if (ImportFileUtil.isImported(itemEntity.getItemJson()) &&
                !ItemConstants.ItemType.TYPE_TUT.equals(itemEntity.getItemJson().getType())) {
            migrate = true;
        }
        return migrate;
    }

    private void removeStyleValuesFromElement(Document document, String elementName) {
        document.getElementsByTag(elementName).forEach(paragraph -> {
            if (paragraph.hasAttr("style")) {
                String paragraphStyle = paragraph.attr("style");

                for (String blackStyle : STYLE_BLACK_LIST) {
                    paragraphStyle = paragraphStyle.replace(blackStyle, "");
                }
                if (paragraphStyle.trim().equals("")) {
                    paragraph.removeAttr("style");
                } else {
                    paragraph.attr("style", paragraphStyle.trim());
                }
            }
        });

    }
}
