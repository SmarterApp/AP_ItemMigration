package org.opentestsystem.ap.migration.migration;

import org.apache.commons.lang3.StringUtils;
import org.jsoup.nodes.Document;
import org.opentestsystem.ap.common.datastore.DataStoreAttachmentManager;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.common.datastore.DataStoreItemManager;
import org.opentestsystem.ap.common.datastore.DataStoreUtility;
import org.opentestsystem.ap.common.datastore.entity.ItemEntity;
import org.opentestsystem.ap.common.model.MiItem;
import org.opentestsystem.ap.common.model.ModelConstants;
import org.opentestsystem.ap.common.model.Table;
import org.opentestsystem.ap.common.saaif.mapper.model.SkipMigration;
import org.opentestsystem.ap.common.saaif.transformer.MapperUtil;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.model.MigrationContext;
import org.opentestsystem.ap.migration.util.ApplicationDependencyProvider;
import org.springframework.stereotype.Component;

@Component
public class Migration3297 extends AbstractMigration {

    public Migration3297(ApplicationDependencyProvider applicationDependencyProvider,
                         ApplicationProperties applicationProperties,
                         DataStoreDataManager dataManager,
                         DataStoreItemManager dataStoreItemManager,
                         DataStoreUtility dataStoreUtility,
                         DataStoreAttachmentManager dataStoreAttachmentManager) {
        super(applicationDependencyProvider, applicationProperties, dataManager, dataStoreItemManager, dataStoreUtility, dataStoreAttachmentManager);
    }

    @Override
    protected ItemEntity migrateEntity(ItemEntity itemEntity, MigrationContext migrationContext) {
        if (!ModelConstants.ItemType.TYPE_MI.equalsIgnoreCase(itemEntity.getItemJson().getType())) {
            throw new SkipMigration(String.format("Item %s is not an MI item; no migration necessary",
                    itemEntity.getItemId()));
        }

        final MiItem miItem = (MiItem) itemEntity.getItemJson();

        updateTableHeaders(miItem.getCore().getEn().getTable());
        updateTableHeaders(miItem.getTranslations().getEsp().getTable());

        return itemEntity;
    }

    private void updateTableHeaders(final Table table) {
        table.getColumns().forEach(column -> {
            column.setLabel(applyMiHeaderFormatting(column.getLabel()));
        });

        table.getRows().stream().filter(row ->
                !row.getCells().isEmpty()).forEach(row -> {
            Table.Cell headerCell = row.getCells().get(0);
            if (headerCell.getType().equals("label")) {
                headerCell.setValue(applyMiHeaderFormatting((String) headerCell.getValue()));
            }
        });
    }

    private String applyMiHeaderFormatting(String value) {
        if (StringUtils.isNotBlank(value)) {
            Document htmlDocument = MapperUtil.newDocument(value);
            String htmlValue = htmlDocument.body().html();
            if (StringUtils.isNotBlank(htmlValue)
                    && !htmlValue.startsWith("<strong>")) {
                return String.format("<strong>%s</strong>", htmlValue);
            }
        }
        return value;
    }
}
