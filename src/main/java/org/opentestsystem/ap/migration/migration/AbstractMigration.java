package org.opentestsystem.ap.migration.migration;

import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.common.client.GitClient;
import org.opentestsystem.ap.common.client.GitlabClient;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.repository.ItemRepository;
import org.opentestsystem.ap.common.saaif.transformer.ModelTransformer;
import org.opentestsystem.ap.common.saaif.transformer.TransformerFactory;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.model.BranchInfo;
import org.opentestsystem.ap.migration.model.ItemInfo;
import org.opentestsystem.ap.migration.model.MigrationResult;
import org.opentestsystem.ap.migration.util.ApplicationUtility;

@Slf4j
public abstract class AbstractMigration implements Migration {

    protected final ApplicationUtility applicationUtility;

    protected final ApplicationProperties applicationProperties;

    protected final GitlabClient gitlabClient;

    protected final ItemRepository itemRepository;

    protected final TransformerFactory transformerFactory;

    protected abstract void runMigration(final ItemInfo itemInfo,
                                         final BranchInfo branchInfo,
                                         final String version,
                                         final ApplicationProperties.MigrationDefinition migration,
                                         final GitClient gitClient);

    protected AbstractMigration(final ApplicationUtility applicationUtility) {
        this.applicationUtility = applicationUtility;
        this.applicationProperties = applicationUtility.getApplicationProperties();
        this.gitlabClient = applicationUtility.getGitlabClient();
        this.itemRepository = applicationUtility.getItemRepository();
        this.transformerFactory = new TransformerFactory();
    }

    @Override
    public MigrationResult migrate(final ItemInfo itemInfo,
                                   final BranchInfo branchInfo,
                                   final String version,
                                   final ApplicationProperties.MigrationDefinition migration,
                                   final GitClient gitClient) {
        log.info("running {}", migration.getMigrationName());

        final MigrationResult migrationResult = new MigrationResult(migration.getMigrationName());

        // if it's the master branch and the item is not public then nothing to migrateAndSave
        if (!branchInfo.isMasterBranch() || itemInfo.isItemPublic()) {
            runMigration(itemInfo, branchInfo, version, migration, gitClient);
            updateItemVersion(version, gitClient);
            gitClient.stageAll();
            gitClient.commit(migration.getMigrationDescription());
        }

        return migrationResult;
    }

    protected void updateItemVersion(final String version, final GitClient gitClient) {
        final Item item = gitClient.readModelFile();
        item.setVersion(version);
        gitClient.writeModelFile(item);
    }

    protected void updateItemFiles(final Item item, final GitClient gitClient) {
        final ModelTransformer transformer = transformerFactory.newTransformer(item.getType());
        transformer.generateSaaifFiles(item, bankKey(), gitClient.getItemContext());
    }

    protected String bankKey() {
        return applicationUtility.getItemBankProperties().getBankKey();
    }
}
