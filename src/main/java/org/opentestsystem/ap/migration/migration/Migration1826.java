package org.opentestsystem.ap.migration.migration;

import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.common.client.GitClient;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemBankUser;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.opentestsystem.ap.common.saaif.metadata.SmarterAppMetadata;
import org.opentestsystem.ap.migration.model.BranchInfo;
import org.opentestsystem.ap.migration.model.ItemInfo;
import org.opentestsystem.ap.migration.model.MigrationDefinition;
import org.opentestsystem.ap.migration.util.Util;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class Migration1826 extends AbstractMigration {

    public Migration1826(Util util) {
        super(util);
    }

    @Override
    protected void runMigration(final ItemInfo itemInfo,
                                final BranchInfo branchInfo,
                                final MigrationDefinition migration,
                                final GitClient gitClient) {
        final Item item = itemRepository.loadItemRemotely(itemInfo.getItemId(), branchInfo.getBranchName());

        final ItemRelease saaifItem = gitClient.readItemFile();
        final SmarterAppMetadata saaifMetadata = gitClient.readMetadataFile();

        // use the repo instance as a base for the item model to update
        final ItemRelease updatedSaaifItem = item.toSaaif(saaifItem, gitClient.getItemContext());
        final SmarterAppMetadata updatedMetadata = item.toSaaifMetadata(saaifMetadata);

        gitClient.writeItemFiles(item, updatedSaaifItem, updatedMetadata);
    }
}
