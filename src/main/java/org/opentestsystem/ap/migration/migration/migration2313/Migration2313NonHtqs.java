package org.opentestsystem.ap.migration.migration.migration2313;

import org.opentestsystem.ap.common.datastore.DataStoreAttachmentManager;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.common.datastore.DataStoreItemManager;
import org.opentestsystem.ap.common.datastore.DataStoreUtility;
import org.opentestsystem.ap.common.datastore.entity.ItemEntity;
import org.opentestsystem.ap.common.model.AssessmentItem;
import org.opentestsystem.ap.common.model.HtqsItem;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.migration.AbstractMigration;
import org.opentestsystem.ap.migration.model.MigrationContext;
import org.opentestsystem.ap.migration.util.ApplicationDependencyProvider;
import org.springframework.stereotype.Component;

import static org.opentestsystem.ap.common.model.ModelConstants.ItemType.TYPE_HTQS;

@Component
public class Migration2313NonHtqs extends AbstractMigration {

    public Migration2313NonHtqs(final ApplicationDependencyProvider applicationDependencyProvider,
                                final ApplicationProperties applicationProperties,
                                final DataStoreDataManager dataManager,
                                final DataStoreUtility dataStoreUtility,
                                final DataStoreAttachmentManager dataStoreAttachmentManager,
                                final DataStoreItemManager dataStoreItemManager) {
        super(applicationDependencyProvider, applicationProperties, dataManager, dataStoreItemManager, dataStoreUtility, dataStoreAttachmentManager);
    }

    /**
     * Set default values on new model properties
     *
     * @param itemEntity The entity record to migrate.
     * @return {@link ItemEntity} the migrated entity
     */
    @Override
    protected ItemEntity migrateEntity(ItemEntity itemEntity, MigrationContext migrationContext) {
        if (shouldMigrateItem(itemEntity)) {
            AssessmentItem item = (AssessmentItem) itemEntity.getItemJson();
            item.getCore().getScoring().setMachineScoringManagedByIat(true);
            if (TYPE_HTQS.equalsIgnoreCase(itemEntity.getItemJson().getType())) {
                HtqsItem htqsItem = (HtqsItem) itemEntity.getItemJson();
                htqsItem.getCore().getEn().getHtqSelectable().setManagedByIat(true);
                htqsItem.getCore().getScoring().setMachineScoringManagedByIat(false);
                itemEntity.setItemJson(htqsItem);
            }
            itemEntity.setItemJson(item);
        }
        return itemEntity;
    }

    /**
     * Apply migration to non-imported HTQS
     *
     * @param itemEntity The entity record to migrate.
     * @return {@code true} if the item is htqs and not imported
     */
    private boolean shouldMigrateItem(ItemEntity itemEntity) {
        Item item = itemEntity.getItemJson();
        return TYPE_HTQS.equalsIgnoreCase(item.getType()) && !item.isImported();
    }
}
