package org.opentestsystem.ap.migration.migration;

import org.opentestsystem.ap.common.datastore.DataStoreAttachmentManager;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.common.datastore.DataStoreUtility;
import org.opentestsystem.ap.common.datastore.entity.ItemEntity;
import org.opentestsystem.ap.common.management.ItemManagerEventProducer;
import org.opentestsystem.ap.common.model.AssessmentItem;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.migration.ApplicationDependencyProvider;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.datastore.AbstractDataStoreMigration;
import org.opentestsystem.ap.migration.util.ImportFileUtil;
import org.springframework.stereotype.Component;

@Component
public class Migration2313NonHtqs extends AbstractDataStoreMigration {

    public Migration2313NonHtqs(ApplicationDependencyProvider applicationDependencyProvider, ApplicationProperties applicationProperties, DataStoreDataManager dataManager, ItemManagerEventProducer eventProducer, DataStoreUtility dataStoreUtility, DataStoreAttachmentManager dataStoreAttachmentManager) {
        super(applicationDependencyProvider, applicationProperties, dataManager, eventProducer, dataStoreUtility, dataStoreAttachmentManager);
    }

    @Override
    protected ItemEntity migrateEntity(ItemEntity itemEntity) {
        if (shouldMigrateItem(itemEntity)) {
            AssessmentItem item = (AssessmentItem) itemEntity.getItemJson();
            item.getCore().getScoring().setManagedByIat(true);
            item.getCore().getScoring().setMachineScoringManagedByIat(true);

            itemEntity.setItemJson(item);
        }
        return itemEntity;
    }

    /**
     * Apply migration to all items except TUT and non-imported HTQS
     * @param itemEntity
     * @return
     */
    private boolean shouldMigrateItem(ItemEntity itemEntity) {
        String entityType = itemEntity.getItemJson().getType();
        return !ItemConstants.ItemType.TYPE_TUT.equalsIgnoreCase(entityType) &&
               (ItemConstants.ItemType.TYPE_HTQS.equalsIgnoreCase(entityType)
                       && !ImportFileUtil.isImported(itemEntity.getItemJson()));
    }
}
