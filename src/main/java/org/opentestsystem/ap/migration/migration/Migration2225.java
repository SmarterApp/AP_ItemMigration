package org.opentestsystem.ap.migration.migration;

import lombok.extern.slf4j.Slf4j;
import org.apache.commons.io.FilenameUtils;
import org.opentestsystem.ap.common.datastore.DataStoreAttachmentManager;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.common.datastore.DataStoreUtility;
import org.opentestsystem.ap.common.datastore.entity.ItemEntity;
import org.opentestsystem.ap.common.management.ItemManagerEventProducer;
import org.opentestsystem.ap.common.model.Attachment;
import org.opentestsystem.ap.migration.ApplicationDependencyProvider;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.datastore.AbstractDataStoreMigration;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class Migration2225 extends AbstractDataStoreMigration {
    private static final String aslEndName = "_STEM";

    public Migration2225(final ApplicationDependencyProvider applicationDependencyProvider,
                         final ApplicationProperties applicationProperties,
                         final DataStoreDataManager dataManager,
                         final ItemManagerEventProducer eventProducer,
                         final DataStoreUtility dataStoreUtility,
                         final DataStoreAttachmentManager dataStoreAttachmentManager) {
        super(applicationDependencyProvider, applicationProperties, dataManager, eventProducer, dataStoreUtility, dataStoreAttachmentManager);
    }

    @Override
    protected ItemEntity migrateEntity(final ItemEntity itemEntity) {
        if(itemEntity.getItemJson().getAsl().getAttachments().isEmpty()) {
            return itemEntity;
        }

        for(Attachment aslAttachment : itemEntity.getItemJson().getAsl().getAttachments()) {
            String fileName = FilenameUtils.getBaseName(aslAttachment.getFileName());

            log.debug("file " + fileName);
            if(fileName.endsWith(aslEndName)) {
                continue;
            }

            String suffix = FilenameUtils.getExtension(aslAttachment.getFileName());

            String newFileName = FilenameUtils.getName(fileName) + aslEndName + "." + suffix;

            log.debug("Changing file to " + newFileName);
            boolean renamed = dataStoreAttachmentManager.renameAttachment(itemEntity.getItemId(), itemEntity.getBranchName(), aslAttachment.getFileName(), newFileName);

            if(renamed) {
                aslAttachment.setFileName(newFileName);
            }
        }

        return itemEntity;
    }
}
