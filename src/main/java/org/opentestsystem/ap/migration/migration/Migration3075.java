package org.opentestsystem.ap.migration.migration;

import org.opentestsystem.ap.common.datastore.DataStoreAttachmentManager;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.common.datastore.DataStoreUtility;
import org.opentestsystem.ap.common.datastore.entity.ItemEntity;
import org.opentestsystem.ap.common.management.ItemManagerEventProducer;
import org.opentestsystem.ap.common.model.AssessmentItem;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.repository.RepositoryUtil;
import org.opentestsystem.ap.common.saaif.mapper.model.SkipMigration;
import org.opentestsystem.ap.migration.ApplicationDependencyProvider;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.model.ItemMerge;
import org.springframework.stereotype.Component;

import java.nio.file.Path;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.List;

import static org.opentestsystem.ap.common.model.ItemConstants.BranchNames.BRANCH_MASTER;
import static org.opentestsystem.ap.common.model.ItemConstants.Section.SECTION_CORE;

/**
 * IAT-3075: Import: machineScoringManagedByIat set to true by import process
 */
@Component
public class Migration3075 extends AbstractImportMigration {

    public Migration3075(final ApplicationProperties applicationProperties,
                         final DataStoreDataManager dataManager,
                         final ItemManagerEventProducer eventProducer,
                         final DataStoreUtility dataStoreUtility,
                         final DataStoreAttachmentManager dataStoreAttachmentManager,
                         final ApplicationDependencyProvider applicationDependencyProvider) {
        super(applicationProperties, dataManager, eventProducer, dataStoreUtility, dataStoreAttachmentManager,
            applicationDependencyProvider);
    }

    @Override
    protected ItemMerge mergeItem(final Item dataStoreItem, final Item mappedItem, final Path itemSyncDir) {
        this.checkSkip(dataStoreItem);

        AssessmentItem item = (AssessmentItem) dataStoreItem;
        item.getCore().getScoring().setMachineScoringManagedByIat(false);

        String qrxFileName = RepositoryUtil.getQrxFileName(item.getId());

        // sync only the QRX
        itemBankSyncManager.syncAttachmentsToDataStore(
            item.getId(),
            BRANCH_MASTER,
            itemSyncDir,
            Arrays.asList(qrxFileName));

        // do not sync
        return new ItemMerge(dataStoreItem, itemSyncDir, DO_NOT_SYNC_ATTACHMENTS);
    }

    @Override
    protected boolean shouldMigrateBranch(ItemEntity migratedEntity) {
        return super.shouldMigrateBranch(migratedEntity)
            || SECTION_CORE.equalsIgnoreCase(migratedEntity.getBranchName());
    }

    @Override
    protected Collection<String> getEditedSectionsBlockingMigration() {
        return Collections.emptyList();
    }

    private void checkSkip(Item item) {
        if (!ITEMS_TO_MIGRATION.contains(item.getId())) {
            throw new SkipMigration(String.format("item %s not in list", item.getId()));
        }
        if (!(item instanceof AssessmentItem)) {
            throw new SkipMigration(String.format("item %s is not an assessment", item.getId()));
        }
    }

    private static final List<String> ITEMS_TO_MIGRATION = new ArrayList<>(344);

    static {
        ITEMS_TO_MIGRATION.add("73");
        ITEMS_TO_MIGRATION.add("75");
        ITEMS_TO_MIGRATION.add("81");
        ITEMS_TO_MIGRATION.add("83");
        ITEMS_TO_MIGRATION.add("85");
        ITEMS_TO_MIGRATION.add("89");
        ITEMS_TO_MIGRATION.add("91");
        ITEMS_TO_MIGRATION.add("93");
        ITEMS_TO_MIGRATION.add("95");
        ITEMS_TO_MIGRATION.add("97");
        ITEMS_TO_MIGRATION.add("99");
        ITEMS_TO_MIGRATION.add("101");
        ITEMS_TO_MIGRATION.add("103");
        ITEMS_TO_MIGRATION.add("107");
        ITEMS_TO_MIGRATION.add("109");
        ITEMS_TO_MIGRATION.add("111");
        ITEMS_TO_MIGRATION.add("115");
        ITEMS_TO_MIGRATION.add("117");
        ITEMS_TO_MIGRATION.add("119");
        ITEMS_TO_MIGRATION.add("121");
        ITEMS_TO_MIGRATION.add("123");
        ITEMS_TO_MIGRATION.add("127");
        ITEMS_TO_MIGRATION.add("129");
        ITEMS_TO_MIGRATION.add("131");
        ITEMS_TO_MIGRATION.add("133");
        ITEMS_TO_MIGRATION.add("137");
        ITEMS_TO_MIGRATION.add("139");
        ITEMS_TO_MIGRATION.add("143");
        ITEMS_TO_MIGRATION.add("145");
        ITEMS_TO_MIGRATION.add("147");
        ITEMS_TO_MIGRATION.add("149");
        ITEMS_TO_MIGRATION.add("151");
        ITEMS_TO_MIGRATION.add("223");
        ITEMS_TO_MIGRATION.add("225");
        ITEMS_TO_MIGRATION.add("231");
        ITEMS_TO_MIGRATION.add("235");
        ITEMS_TO_MIGRATION.add("241");
        ITEMS_TO_MIGRATION.add("243");
        ITEMS_TO_MIGRATION.add("245");
        ITEMS_TO_MIGRATION.add("247");
        ITEMS_TO_MIGRATION.add("249");
        ITEMS_TO_MIGRATION.add("255");
        ITEMS_TO_MIGRATION.add("257");
        ITEMS_TO_MIGRATION.add("261");
        ITEMS_TO_MIGRATION.add("269");
        ITEMS_TO_MIGRATION.add("271");
        ITEMS_TO_MIGRATION.add("297");
        ITEMS_TO_MIGRATION.add("315");
        ITEMS_TO_MIGRATION.add("327");
        ITEMS_TO_MIGRATION.add("331");
        ITEMS_TO_MIGRATION.add("341");
        ITEMS_TO_MIGRATION.add("349");
        ITEMS_TO_MIGRATION.add("351");
        ITEMS_TO_MIGRATION.add("361");
        ITEMS_TO_MIGRATION.add("363");
        ITEMS_TO_MIGRATION.add("419");
        ITEMS_TO_MIGRATION.add("429");
        ITEMS_TO_MIGRATION.add("431");
        ITEMS_TO_MIGRATION.add("433");
        ITEMS_TO_MIGRATION.add("443");
        ITEMS_TO_MIGRATION.add("445");
        ITEMS_TO_MIGRATION.add("457");
        ITEMS_TO_MIGRATION.add("465");
        ITEMS_TO_MIGRATION.add("475");
        ITEMS_TO_MIGRATION.add("481");
        ITEMS_TO_MIGRATION.add("483");
        ITEMS_TO_MIGRATION.add("485");
        ITEMS_TO_MIGRATION.add("493");
        ITEMS_TO_MIGRATION.add("495");
        ITEMS_TO_MIGRATION.add("501");
        ITEMS_TO_MIGRATION.add("509");
        ITEMS_TO_MIGRATION.add("511");
        ITEMS_TO_MIGRATION.add("519");
        ITEMS_TO_MIGRATION.add("522");
        ITEMS_TO_MIGRATION.add("524");
        ITEMS_TO_MIGRATION.add("534");
        ITEMS_TO_MIGRATION.add("548");
        ITEMS_TO_MIGRATION.add("552");
        ITEMS_TO_MIGRATION.add("554");
        ITEMS_TO_MIGRATION.add("556");
        ITEMS_TO_MIGRATION.add("558");
        ITEMS_TO_MIGRATION.add("560");
        ITEMS_TO_MIGRATION.add("564");
        ITEMS_TO_MIGRATION.add("570");
        ITEMS_TO_MIGRATION.add("578");
        ITEMS_TO_MIGRATION.add("602");
        ITEMS_TO_MIGRATION.add("620");
        ITEMS_TO_MIGRATION.add("622");
        ITEMS_TO_MIGRATION.add("628");
        ITEMS_TO_MIGRATION.add("638");
        ITEMS_TO_MIGRATION.add("642");
        ITEMS_TO_MIGRATION.add("648");
        ITEMS_TO_MIGRATION.add("650");
        ITEMS_TO_MIGRATION.add("652");
        ITEMS_TO_MIGRATION.add("656");
        ITEMS_TO_MIGRATION.add("658");
        ITEMS_TO_MIGRATION.add("660");
        ITEMS_TO_MIGRATION.add("662");
        ITEMS_TO_MIGRATION.add("664");
        ITEMS_TO_MIGRATION.add("666");
        ITEMS_TO_MIGRATION.add("668");
        ITEMS_TO_MIGRATION.add("672");
        ITEMS_TO_MIGRATION.add("674");
        ITEMS_TO_MIGRATION.add("678");
        ITEMS_TO_MIGRATION.add("680");
        ITEMS_TO_MIGRATION.add("682");
        ITEMS_TO_MIGRATION.add("688");
        ITEMS_TO_MIGRATION.add("690");
        ITEMS_TO_MIGRATION.add("700");
        ITEMS_TO_MIGRATION.add("702");
        ITEMS_TO_MIGRATION.add("706");
        ITEMS_TO_MIGRATION.add("708");
        ITEMS_TO_MIGRATION.add("710");
        ITEMS_TO_MIGRATION.add("714");
        ITEMS_TO_MIGRATION.add("716");
        ITEMS_TO_MIGRATION.add("718");
        ITEMS_TO_MIGRATION.add("732");
        ITEMS_TO_MIGRATION.add("734");
        ITEMS_TO_MIGRATION.add("736");
        ITEMS_TO_MIGRATION.add("738");
        ITEMS_TO_MIGRATION.add("742");
        ITEMS_TO_MIGRATION.add("744");
        ITEMS_TO_MIGRATION.add("746");
        ITEMS_TO_MIGRATION.add("748");
        ITEMS_TO_MIGRATION.add("752");
        ITEMS_TO_MIGRATION.add("754");
        ITEMS_TO_MIGRATION.add("756");
        ITEMS_TO_MIGRATION.add("760");
        ITEMS_TO_MIGRATION.add("762");
        ITEMS_TO_MIGRATION.add("764");
        ITEMS_TO_MIGRATION.add("766");
        ITEMS_TO_MIGRATION.add("768");
        ITEMS_TO_MIGRATION.add("770");
        ITEMS_TO_MIGRATION.add("772");
        ITEMS_TO_MIGRATION.add("774");
        ITEMS_TO_MIGRATION.add("776");
        ITEMS_TO_MIGRATION.add("778");
        ITEMS_TO_MIGRATION.add("780");
        ITEMS_TO_MIGRATION.add("782");
        ITEMS_TO_MIGRATION.add("786");
        ITEMS_TO_MIGRATION.add("788");
        ITEMS_TO_MIGRATION.add("794");
        ITEMS_TO_MIGRATION.add("796");
        ITEMS_TO_MIGRATION.add("798");
        ITEMS_TO_MIGRATION.add("800");
        ITEMS_TO_MIGRATION.add("802");
        ITEMS_TO_MIGRATION.add("804");
        ITEMS_TO_MIGRATION.add("806");
        ITEMS_TO_MIGRATION.add("808");
        ITEMS_TO_MIGRATION.add("810");
        ITEMS_TO_MIGRATION.add("812");
        ITEMS_TO_MIGRATION.add("814");
        ITEMS_TO_MIGRATION.add("818");
        ITEMS_TO_MIGRATION.add("820");
        ITEMS_TO_MIGRATION.add("822");
        ITEMS_TO_MIGRATION.add("824");
        ITEMS_TO_MIGRATION.add("828");
        ITEMS_TO_MIGRATION.add("830");
        ITEMS_TO_MIGRATION.add("832");
        ITEMS_TO_MIGRATION.add("838");
        ITEMS_TO_MIGRATION.add("840");
        ITEMS_TO_MIGRATION.add("842");
        ITEMS_TO_MIGRATION.add("844");
        ITEMS_TO_MIGRATION.add("846");
        ITEMS_TO_MIGRATION.add("848");
        ITEMS_TO_MIGRATION.add("850");
        ITEMS_TO_MIGRATION.add("862");
        ITEMS_TO_MIGRATION.add("864");
        ITEMS_TO_MIGRATION.add("866");
        ITEMS_TO_MIGRATION.add("884");
        ITEMS_TO_MIGRATION.add("890");
        ITEMS_TO_MIGRATION.add("892");
        ITEMS_TO_MIGRATION.add("900");
        ITEMS_TO_MIGRATION.add("924");
        ITEMS_TO_MIGRATION.add("926");
        ITEMS_TO_MIGRATION.add("928");
        ITEMS_TO_MIGRATION.add("938");
        ITEMS_TO_MIGRATION.add("940");
        ITEMS_TO_MIGRATION.add("952");
        ITEMS_TO_MIGRATION.add("954");
        ITEMS_TO_MIGRATION.add("972");
        ITEMS_TO_MIGRATION.add("974");
        ITEMS_TO_MIGRATION.add("996");
        ITEMS_TO_MIGRATION.add("1004");
        ITEMS_TO_MIGRATION.add("1226");
        ITEMS_TO_MIGRATION.add("1228");
        ITEMS_TO_MIGRATION.add("1230");
        ITEMS_TO_MIGRATION.add("1232");
        ITEMS_TO_MIGRATION.add("1234");
        ITEMS_TO_MIGRATION.add("1236");
        ITEMS_TO_MIGRATION.add("1238");
        ITEMS_TO_MIGRATION.add("1240");
        ITEMS_TO_MIGRATION.add("1244");
        ITEMS_TO_MIGRATION.add("1246");
        ITEMS_TO_MIGRATION.add("1248");
        ITEMS_TO_MIGRATION.add("1252");
        ITEMS_TO_MIGRATION.add("1256");
        ITEMS_TO_MIGRATION.add("1258");
        ITEMS_TO_MIGRATION.add("1260");
        ITEMS_TO_MIGRATION.add("1262");
        ITEMS_TO_MIGRATION.add("1268");
        ITEMS_TO_MIGRATION.add("1270");
        ITEMS_TO_MIGRATION.add("1272");
        ITEMS_TO_MIGRATION.add("1274");
        ITEMS_TO_MIGRATION.add("1278");
        ITEMS_TO_MIGRATION.add("1280");
        ITEMS_TO_MIGRATION.add("1284");
        ITEMS_TO_MIGRATION.add("1286");
        ITEMS_TO_MIGRATION.add("1292");
        ITEMS_TO_MIGRATION.add("1294");
        ITEMS_TO_MIGRATION.add("1296");
        ITEMS_TO_MIGRATION.add("1298");
        ITEMS_TO_MIGRATION.add("1300");
        ITEMS_TO_MIGRATION.add("1308");
        ITEMS_TO_MIGRATION.add("1310");
        ITEMS_TO_MIGRATION.add("1312");
        ITEMS_TO_MIGRATION.add("1314");
        ITEMS_TO_MIGRATION.add("1322");
        ITEMS_TO_MIGRATION.add("1324");
        ITEMS_TO_MIGRATION.add("1478");
        ITEMS_TO_MIGRATION.add("1484");
        ITEMS_TO_MIGRATION.add("1586");
        ITEMS_TO_MIGRATION.add("1788");
        ITEMS_TO_MIGRATION.add("2014");
        ITEMS_TO_MIGRATION.add("2622");
        ITEMS_TO_MIGRATION.add("2650");
        ITEMS_TO_MIGRATION.add("3018");
        ITEMS_TO_MIGRATION.add("3052");
        ITEMS_TO_MIGRATION.add("3054");
        ITEMS_TO_MIGRATION.add("3453");
        ITEMS_TO_MIGRATION.add("3498");
        ITEMS_TO_MIGRATION.add("3738");
        ITEMS_TO_MIGRATION.add("3740");
        ITEMS_TO_MIGRATION.add("3760");
        ITEMS_TO_MIGRATION.add("3781");
        ITEMS_TO_MIGRATION.add("3885");
        ITEMS_TO_MIGRATION.add("4039");
        ITEMS_TO_MIGRATION.add("4260");
        ITEMS_TO_MIGRATION.add("4394");
        ITEMS_TO_MIGRATION.add("4420");
        ITEMS_TO_MIGRATION.add("4488");
        ITEMS_TO_MIGRATION.add("4850");
        ITEMS_TO_MIGRATION.add("4858");
        ITEMS_TO_MIGRATION.add("4932");
        ITEMS_TO_MIGRATION.add("5639");
        ITEMS_TO_MIGRATION.add("5687");
        ITEMS_TO_MIGRATION.add("5711");
        ITEMS_TO_MIGRATION.add("5996");
        ITEMS_TO_MIGRATION.add("6113");
        ITEMS_TO_MIGRATION.add("6117");
        ITEMS_TO_MIGRATION.add("6119");
        ITEMS_TO_MIGRATION.add("6165");
        ITEMS_TO_MIGRATION.add("6692");
        ITEMS_TO_MIGRATION.add("7238");
        ITEMS_TO_MIGRATION.add("7284");
        ITEMS_TO_MIGRATION.add("7762");
        ITEMS_TO_MIGRATION.add("7772");
        ITEMS_TO_MIGRATION.add("7830");
        ITEMS_TO_MIGRATION.add("7904");
        ITEMS_TO_MIGRATION.add("8037");
        ITEMS_TO_MIGRATION.add("8196");
        ITEMS_TO_MIGRATION.add("8204");
        ITEMS_TO_MIGRATION.add("8278");
        ITEMS_TO_MIGRATION.add("9041");
        ITEMS_TO_MIGRATION.add("9559");
        ITEMS_TO_MIGRATION.add("9625");
        ITEMS_TO_MIGRATION.add("10438");
        ITEMS_TO_MIGRATION.add("11068");
        ITEMS_TO_MIGRATION.add("11221");
        ITEMS_TO_MIGRATION.add("11315");
        ITEMS_TO_MIGRATION.add("12029");
        ITEMS_TO_MIGRATION.add("12035");
        ITEMS_TO_MIGRATION.add("12878");
        ITEMS_TO_MIGRATION.add("13308");
        ITEMS_TO_MIGRATION.add("13311");
        ITEMS_TO_MIGRATION.add("13312");
        ITEMS_TO_MIGRATION.add("13696");
        ITEMS_TO_MIGRATION.add("14804");
        ITEMS_TO_MIGRATION.add("14806");
        ITEMS_TO_MIGRATION.add("14810");
        ITEMS_TO_MIGRATION.add("14812");
        ITEMS_TO_MIGRATION.add("14830");
        ITEMS_TO_MIGRATION.add("14838");
        ITEMS_TO_MIGRATION.add("14845");
        ITEMS_TO_MIGRATION.add("14851");
        ITEMS_TO_MIGRATION.add("15053");
        ITEMS_TO_MIGRATION.add("15138");
        ITEMS_TO_MIGRATION.add("16217");
        ITEMS_TO_MIGRATION.add("18249");
        ITEMS_TO_MIGRATION.add("18361");
        ITEMS_TO_MIGRATION.add("18591");
        ITEMS_TO_MIGRATION.add("18746");
        ITEMS_TO_MIGRATION.add("19676");
        ITEMS_TO_MIGRATION.add("19677");
        ITEMS_TO_MIGRATION.add("19678");
        ITEMS_TO_MIGRATION.add("19679");
        ITEMS_TO_MIGRATION.add("20411");
        ITEMS_TO_MIGRATION.add("20976");
        ITEMS_TO_MIGRATION.add("21337");
        ITEMS_TO_MIGRATION.add("21557");
        ITEMS_TO_MIGRATION.add("22034");
        ITEMS_TO_MIGRATION.add("22276");
        ITEMS_TO_MIGRATION.add("23099");
        ITEMS_TO_MIGRATION.add("25655");
        ITEMS_TO_MIGRATION.add("25662");
        ITEMS_TO_MIGRATION.add("27213");
        ITEMS_TO_MIGRATION.add("27218");
        ITEMS_TO_MIGRATION.add("29634");
        ITEMS_TO_MIGRATION.add("42973");
        ITEMS_TO_MIGRATION.add("45725");
        ITEMS_TO_MIGRATION.add("45742");
        ITEMS_TO_MIGRATION.add("76585");
        ITEMS_TO_MIGRATION.add("76745");
        ITEMS_TO_MIGRATION.add("76749");
        ITEMS_TO_MIGRATION.add("76959");
        ITEMS_TO_MIGRATION.add("77754");
        ITEMS_TO_MIGRATION.add("77820");
        ITEMS_TO_MIGRATION.add("78451");
        ITEMS_TO_MIGRATION.add("78516");
        ITEMS_TO_MIGRATION.add("79238");
        ITEMS_TO_MIGRATION.add("79446");
        ITEMS_TO_MIGRATION.add("79675");
        ITEMS_TO_MIGRATION.add("80180");
        ITEMS_TO_MIGRATION.add("80186");
        ITEMS_TO_MIGRATION.add("80285");
        ITEMS_TO_MIGRATION.add("80289");
        ITEMS_TO_MIGRATION.add("80453");
        ITEMS_TO_MIGRATION.add("80603");
        ITEMS_TO_MIGRATION.add("80687");
        ITEMS_TO_MIGRATION.add("80783");
        ITEMS_TO_MIGRATION.add("80889");
        ITEMS_TO_MIGRATION.add("83942");
        ITEMS_TO_MIGRATION.add("84064");
        ITEMS_TO_MIGRATION.add("84279");
        ITEMS_TO_MIGRATION.add("84287");
        ITEMS_TO_MIGRATION.add("84392");
        ITEMS_TO_MIGRATION.add("86423");
        ITEMS_TO_MIGRATION.add("88398");
        ITEMS_TO_MIGRATION.add("88436");
        ITEMS_TO_MIGRATION.add("93866");
        ITEMS_TO_MIGRATION.add("127650");
        ITEMS_TO_MIGRATION.add("128808");
        ITEMS_TO_MIGRATION.add("128989");
        ITEMS_TO_MIGRATION.add("129394");
    }
}
