package org.opentestsystem.ap.migration.service;

import java.util.List;

import lombok.extern.slf4j.Slf4j;
import org.gitlab4j.api.models.Project;
import org.opentestsystem.ap.common.client.GitlabClient;
import org.opentestsystem.ap.migration.config.AppProps;
import org.opentestsystem.ap.migration.util.Util;
import org.springframework.stereotype.Component;

import static org.apache.commons.collections4.CollectionUtils.isNotEmpty;
import static org.apache.commons.collections4.ListUtils.emptyIfNull;

@Slf4j
@Component
public class DeletionService {

    private final Util util;

    private final AppProps appProps;

    private final GitlabClient gitlabClient;

    public DeletionService(final Util util, final GitlabClient gitlabClient) {
        this.util = util;
        appProps = util.getAppProps();
        this.gitlabClient = gitlabClient;
    }

    public void deleteItems() {
        if (appProps.isDeleteItemsEnabled()) {
            log.info("Item deletion is enabled");
            logItemsToKeep();
            deleteProjects(util.getProjects());
        } else {
            log.info("Item deletion is disabled");
        }
    }

    private void deleteProjects(final List<Project> projects) {
        if (isNotEmpty(projects)) {
//            projects.forEach(this::deleteProject);
        }
    }

    private void deleteProject(final Project project) {
        final List<String> itemsToKeep = emptyIfNull(appProps.getDoNotDeleteItems());

        final String itemId = project.getName();

        // if its not in the list then it should be deleted
        if(!itemsToKeep.contains(itemId)) {
            log.info("deleting item {}", itemId);
//            gitlabClient.deleteProject(project);
        } else {
            log.debug("skip deleting item {}", itemId);
        }
    }

    private void logItemsToKeep() {
        if (log.isInfoEnabled()) {
            log.info("Items to keep: {}", String.join(",", appProps.getDoNotDeleteItems()));
        }
    }
}
