package org.opentestsystem.ap.migration.service;

import java.util.List;
import java.util.function.Function;
import java.util.stream.Collectors;

import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.opentestsystem.ap.common.client.GitClientFactory;
import org.opentestsystem.ap.common.config.ItemBankProperties;
import org.opentestsystem.ap.migration.config.AppProps;
import org.opentestsystem.ap.migration.config.ApplicationDependencyProvider;
import org.opentestsystem.ap.migration.util.Util;
import org.springframework.stereotype.Component;

import static org.opentestsystem.ap.common.repository.RepositoryUtil.generateRepositoryURI;

@Slf4j
@Component
public class DownloadService {

    private final AppProps appProps;

    private final GitClientFactory gitClientFactory;

    private final ItemBankProperties itemBankProperties;

    public DownloadService(final Util util, final ApplicationDependencyProvider dependencyProvider) {
        this.appProps = dependencyProvider.getAppProps();
        gitClientFactory = dependencyProvider.getGitClientFactory();
        itemBankProperties = dependencyProvider.getItemBankProperties();
    }

    /**
     * Executes the migration process against an itembank.
     */
    public void download() {
        if (appProps.isDownloadItemsEnabled()) {
            log.info("item download is enabled");
            final List<String> includedItems = appProps.getIncludedItems();
            final List<String> results = includedItems.stream().map(downloadItem()).collect(Collectors.toList());

            log.info("Results:");
            results.forEach(r -> log.info("\t{}", r));
            log.info("download complete");
        } else {
            log.info("item download is disabled");
        }
    }

    private Function<String, String> downloadItem() {
        return itemId -> {
            log.info("downloading {}", itemId);
            try {
                final String repositoryURI = generateRepositoryURI(
                    itemBankProperties.getHost(), appProps.getItemBankNamespace(), itemId);

                gitClientFactory.cloneURL(appProps.getSystemUser(), itemId, repositoryURI);

                return itemId + " success";
            } catch (Exception e) {
                return itemId + " failed: " + ExceptionUtils.getRootCauseMessage(e);
            }
        };
    }
}
