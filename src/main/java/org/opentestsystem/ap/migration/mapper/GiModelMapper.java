package org.opentestsystem.ap.migration.mapper;

import lombok.NoArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.parser.Parser;
import org.opentestsystem.ap.common.model.GiItem;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.opentestsystem.ap.migration.model.ItemMappingProperties;
import org.opentestsystem.ap.migration.model.ItemMappingResult;
import org.opentestsystem.ap.migration.util.MigrationFileUtil;
import org.opentestsystem.ap.migration.util.MigrationMapperUtil;
import org.opentestsystem.ap.migration.util.MigrationXmlUtil;

import java.io.File;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Date;
import java.util.Objects;

import static org.opentestsystem.ap.common.model.ItemConstants.ItemVersion.ITEM_VERSION;
import static org.opentestsystem.ap.common.repository.RepositoryUtil.getQrxFileName;

@Slf4j
@NoArgsConstructor
public class GiModelMapper extends IatModelMapper {
    @Override
    Item mapContent(Item item,
                    ItemRelease release,
                    Path itemLocalPath,
                    String itemSourceFullPath,
                    ItemMappingResult mappingResult) {
        GiItem giItem = (GiItem) item;
        String itemDestinationFullPath = itemLocalPath.toString();

        ItemMappingProperties mappingProperties = new ItemMappingProperties();
        for (ItemRelease.Item.Content content : release.getItem().getContent()) {
            // Assign prompt
            if (content.getLanguage().equals(ItemConstants.ItemLanguage.LANG_ENU)) {
                mappingProperties = mapRichTextContent(content.getLanguage(), content.getStem(), content.getApipAccessibility(), mappingProperties);
                giItem.getCore().getEn().setPrompt(mappingProperties.getContent());

            } else if (content.getLanguage().equals(ItemConstants.ItemLanguage.LANG_ESN)) {
                mappingProperties = mapRichTextContent(content.getLanguage(), content.getStem(), content.getApipAccessibility(), mappingProperties);
                giItem.getTranslations().getEsp().setIsRequired("true");
                giItem.getTranslations().getEsp().setProvided(true);
                giItem.getTranslations().getEsp().setPrompt(mappingProperties.getContent());
            }

            // Process attachments
            processAttachments(content, giItem, itemSourceFullPath, itemDestinationFullPath, mappingResult);
        }

        //Process Image Resources
        processImageResources(mappingProperties, giItem, itemSourceFullPath, itemDestinationFullPath, mappingResult);

        //Create GI Zip file
        processGiFiles(giItem, release, itemSourceFullPath, itemDestinationFullPath, mappingResult);

        return giItem;
    }

    private void processGiFiles(GiItem giItem,
                                ItemRelease release,
                                String sourceDir,
                                String destinationDir,
                                ItemMappingResult itemMappingResult) {
        File gaxFile = MigrationMapperUtil.getRendererSpecFileFromItemRelease(release, sourceDir);
        if (null != gaxFile) {
            copyGaxFiles(gaxFile, sourceDir, destinationDir, itemMappingResult);

            if (createGiZipFile(giItem, release.getItem(), gaxFile, sourceDir, destinationDir, itemMappingResult)) {
                giItem.getCore().getEn().getContentZipFile().setFileName(MigrationFileUtil.GI_SAMPLE_FILE_NAME);
                giItem.getCore().getEn().getContentZipFile().setUploadedDate(new Date());
            }
        }
    }

    private boolean createGiZipFile(GiItem giItem,
                                    ItemRelease.Item saaifItem,
                                    File gaxFile,
                                    String sourceDir,
                                    String destDir,
                                    ItemMappingResult itemMappingResult) {
        try {
            Path sourceFolder = Paths.get(sourceDir);

            Path destinationFolder = Paths.get(destDir);

            // Create directory to store files that will be included in gi-sample.zip
            Path giSampleFolder = MigrationFileUtil.createGiSampleDirectory(sourceDir);

            // Copy gaxFile
            MigrationFileUtil.copyFile(gaxFile, giSampleFolder.toFile(), itemMappingResult);

            // Copy all files referenced in the gax file
            MigrationXmlUtil.getFileSpecListFromFile(gaxFile).forEach(fileName -> {
                MigrationFileUtil.copyFile(sourceFolder.resolve(fileName), giSampleFolder, itemMappingResult);
            });

            // Import Qrx file if present in import directory
            File originalQrxFile = MigrationMapperUtil.getQrxFileFromSaaifItem(saaifItem, sourceDir);

            if (Objects.nonNull(originalQrxFile)) {
                String timsQrxFileName = getQrxFileName(giItem.getId(), ITEM_VERSION);
                // copy to zip folder
                MigrationFileUtil.copyFile(
                        sourceFolder.resolve(originalQrxFile.getName()),
                        giSampleFolder.resolve(timsQrxFileName),
                        itemMappingResult);
                // copy to destination folder
                MigrationFileUtil.copyFile(
                        sourceFolder.resolve(originalQrxFile.getName()),
                        destinationFolder.resolve(timsQrxFileName),
                        itemMappingResult);

                giItem.getCore().getScoring().setManagedByIat(false);
            }

            // Create zip from the GI sample folder and place it in the destination folder
            MigrationFileUtil.zipDirectory(giSampleFolder.toString(),
                    destinationFolder.toString(),
                    MigrationFileUtil.GI_SAMPLE_FILE_NAME);

            // Delete tempSampleDir
            MigrationFileUtil.deleteDirectory(giSampleFolder.toFile());

            return true;
        } catch (Exception ex) {
            String message = String.format("Unable to create GiZipFile in: %s", sourceDir);
            itemMappingResult.getErrorMessages().add(message);
            log.error(message, ex);
            return false;
        }
    }

    private void copyGaxFiles(File gaxFile,
                              String sourceDir,
                              String destinationDir,
                              ItemMappingResult itemMappingResult) {
        final Document gaxDoc = Jsoup.parse(MigrationFileUtil.fileToString(gaxFile),
                "", Parser.xmlParser());

        gaxDoc.getElementsByTag("Filespec").forEach(filespec -> {
            MigrationFileUtil.copyFile(sourceDir + "/" + filespec.text(),
                    destinationDir + "/" + filespec.text(),
                    itemMappingResult);
        });

        gaxDoc.getElementsByTag("Image").forEach(image -> {
            MigrationFileUtil.copyFile(sourceDir + "/" + image.attr("src"),
                    destinationDir + "/" + image.attr("src"),
                    itemMappingResult);
        });
    }

}
