package org.opentestsystem.ap.migration.mapper;

import lombok.NoArgsConstructor;
import org.apache.commons.lang3.StringUtils;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.parser.Parser;
import org.opentestsystem.ap.common.model.HtqsItem;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.opentestsystem.ap.migration.model.ItemMappingProperties;
import org.opentestsystem.ap.migration.model.ItemMappingResult;

import javax.xml.bind.JAXBElement;
import java.io.Serializable;
import java.nio.file.Path;
import java.util.Objects;

@NoArgsConstructor
public class HtqsModelMapper extends IatModelMapper {

    @Override
    Item mapContent(Item item,
                    ItemRelease release,
                    Path itemLocalPath,
                    String itemSourceFullPath,
                    ItemMappingResult mappingResult) {
        HtqsItem htqsItem = (HtqsItem) item;
        String itemDestinationFullPath = itemLocalPath.toString();

        htqsItem.getCore().setHtqType("selectable");

        ItemMappingProperties mappingProperties = new ItemMappingProperties();
        for (ItemRelease.Item.Content content : release.getItem().getContent()) {
            if (content.getLanguage().equals(ItemConstants.ItemLanguage.LANG_ENU)) {
                // Call main IAT mapping function
                mappingProperties = mapHtqsContent(content, mappingProperties);

                htqsItem.getCore().getEn().setPrompt(mappingProperties.getContent());
                htqsItem.getCore().getEn().getHtqSelectable().setManagedByIat(false);
                htqsItem.getCore().getEn().getHtqSelectable()
                        .setInteractiveText(mappingProperties.getInteractiveText());
                htqsItem.getCore().getScoring().setRubric(getRubricFromContent(content, mappingProperties));

                this.setTextToSpeechFlags(htqsItem, mappingProperties);
            } else if (content.getLanguage().equals(ItemConstants.ItemLanguage.LANG_ESN)) {
                mappingProperties = mapHtqsContent(content, mappingProperties);
                htqsItem.getTranslations().getEsp().setIsRequired("true");
                htqsItem.getTranslations().getEsp().setProvided(true);

                htqsItem.getTranslations().getEsp().setPrompt(mappingProperties.getContent());
                htqsItem.getTranslations().getEsp().getHtqSelectable().setManagedByIat(false);
                htqsItem.getTranslations().getEsp().getHtqSelectable()
                        .setInteractiveText(mappingProperties.getInteractiveText());
            }

            // Process attachments
            processAttachments(content, htqsItem, itemSourceFullPath, itemDestinationFullPath, mappingResult);
        }

        //Process Image Resources
        processImageResources(mappingProperties, htqsItem, itemSourceFullPath, itemDestinationFullPath, mappingResult);

        // Import Qrx file
        processMachineRubric(htqsItem, release.getItem(), itemSourceFullPath, itemDestinationFullPath, mappingResult);

        htqsItem.getCore().getScoring().setManagedByIat(true);
        htqsItem.getCore().getScoring().setMachineScoringManagedByIat(false);

        return htqsItem;
    }


    /**
     * @param content
     * @param mappingProperties
     * @return
     */
    private ItemMappingProperties mapHtqsContent(ItemRelease.Item.Content content,
                                                 ItemMappingProperties mappingProperties) {
        final Document doc = Jsoup.parse(content.getStem(), "", Parser.xmlParser());

        StringBuilder prompt = new StringBuilder();
        StringBuilder interText = new StringBuilder();

        boolean interTextStarted = false;
        for (Element p : doc.getElementsByTag("p")) {
            if (!p.html().equals("&nbsp;")) {
                if (p.getElementsByClass("interaction selectable").size() == 0 && !interTextStarted) {
                    prompt.append(p.outerHtml());
                } else {
                    interTextStarted = true;
                    interText.append(p.outerHtml());
                }
            } else {
                prompt.append(p.outerHtml());
            }
        }

        String mappedPrompt = mapRichTextContent(content.getLanguage(), prompt.toString(),
                content.getApipAccessibility(), mappingProperties).getContent();
        String mappedInteractiveText = mapRichTextContent(content.getLanguage(), interText.toString(),
                content.getApipAccessibility(), mappingProperties).getContent();

        mappingProperties.setContent(mappedPrompt);
        mappingProperties.setInteractiveText(mappedInteractiveText);

        return mappingProperties;
    }

    private String getRubricFromContent(ItemRelease.Item.Content content, ItemMappingProperties mappingProperties) {
        StringBuilder rubricContent = new StringBuilder();
        if (!Objects.isNull(content.getRubriclist())) {
            for (Serializable element : content.getRubriclist().getContent()) {
                if (element instanceof JAXBElement) {
                    JAXBElement jaxbElement = (JAXBElement) element;
                    if (jaxbElement.getName().toString().equals("rubric")) {
                        ItemRelease.Item.Content.Rubriclist.Rubric rubric =
                                (ItemRelease.Item.Content.Rubriclist.Rubric) jaxbElement.getValue();
                        String value = rubric.getVal();
                        if (StringUtils.isNotBlank(value)) {
                            rubricContent.append(mapRichTextContent(content.getLanguage(), removeHtmlEntities(value),
                                    content.getApipAccessibility(), mappingProperties).getContent());
                        }
                    }
                }
            }
        }
        return rubricContent.toString();
    }

    private String removeHtmlEntities(String htmlContent) {
        return htmlContent
                .replace("&lt;", "")
                .replace("&gt;", "");
    }
}
