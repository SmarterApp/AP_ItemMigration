package org.opentestsystem.ap.migration.mapper;

import lombok.NoArgsConstructor;
import org.apache.commons.lang3.StringUtils;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.model.SaItem;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.opentestsystem.ap.migration.model.ItemMappingProperties;
import org.opentestsystem.ap.migration.model.ItemMappingResult;

import javax.xml.bind.JAXBElement;
import java.io.Serializable;
import java.nio.file.Path;

@NoArgsConstructor
public class SaModelMapper extends IatModelMapper {

    @Override
    Item mapContent(Item item,
                    ItemRelease release,
                    Path itemLocalPath,
                    String itemSourceFullPath,
                    ItemMappingResult mappingResult) {
        SaItem saItem = (SaItem) item;
        String itemDestinationFullPath = itemLocalPath.toString();

        ItemMappingProperties mappingProperties = new ItemMappingProperties();
        for (ItemRelease.Item.Content content : release.getItem().getContent()) {

            if (content.getLanguage().equals(ItemConstants.ItemLanguage.LANG_ENU)) {
                // Call main IAT mapping function
                mappingProperties = mapRichTextContent(content.getStem(), content.getApipAccessibility(), mappingProperties);

                saItem.getCore().getEn().setPrompt(mappingProperties.getContent());

                // TODO: Refactor mapping rubrics
                // Map Rubrics
                if (content.getRubriclist() != null) {
                    for (Serializable element : content.getRubriclist().getContent()) {
                        JAXBElement jaxbElement = (JAXBElement) element;
                        if (jaxbElement.getName().toString().equals("rubric")) {
                            ItemRelease.Item.Content.Rubriclist.Rubric rubric =
                                    (ItemRelease.Item.Content.Rubriclist.Rubric) jaxbElement.getValue();
                            if (StringUtils.isNotBlank(rubric.getVal())) {
                                String iatRubric = mapRichTextContent(rubric.getVal(),
                                        content.getApipAccessibility(), mappingProperties).getContent();
                                saItem.getCore().getEn().getRubrics().add(iatRubric);
                            }
                        } else if (jaxbElement.getName().toString().equals("samplelist")) {
                            ItemRelease.Item.Content.Rubriclist.Samplelist samplelist =
                                    (ItemRelease.Item.Content.Rubriclist.Samplelist) jaxbElement.getValue();

                            for (ItemRelease.Item.Content.Rubriclist.Samplelist.Sample sample : samplelist.getSample()) {
                                if (StringUtils.isNotBlank(sample.getSamplecontent())) {
                                    String iatExemplar = mapRichTextContent(sample.getSamplecontent(),
                                            content.getApipAccessibility(), mappingProperties).getContent();
                                    saItem.getCore().getEn().getExemplarResponses().add(iatExemplar);
                                }
                            }
                        }
                    }
                }
            } else if (content.getLanguage().equals(ItemConstants.ItemLanguage.LANG_ESN)) {
                // Call main IAT mapping function
                mappingProperties = mapRichTextContent(getEsnContent(content.getStem()), content.getApipAccessibility(), mappingProperties);

                saItem.getTranslations().getEsp().setIsRequired("true");
                saItem.getTranslations().getEsp().setProvided(true);
                saItem.getTranslations().getEsp().setPrompt(mappingProperties.getContent());

                // TODO: Refactor mapping rubrics
                // Map Rubrics
                if (content.getRubriclist() != null) {
                    for (Serializable element : content.getRubriclist().getContent()) {
                        JAXBElement jaxbElement = (JAXBElement) element;
                        if (jaxbElement.getName().toString().equals("rubric")) {
                            ItemRelease.Item.Content.Rubriclist.Rubric rubric =
                                    (ItemRelease.Item.Content.Rubriclist.Rubric) jaxbElement.getValue();
                            if (StringUtils.isNotBlank(rubric.getVal())) {
                                String iatRubric = mapRichTextContent(rubric.getVal(),
                                        content.getApipAccessibility(), mappingProperties).getContent();
                                saItem.getTranslations().getEsp().getRubrics().add(iatRubric);
                            }
                        } else if (jaxbElement.getName().toString().equals("samplelist")) {
                            ItemRelease.Item.Content.Rubriclist.Samplelist samplelist =
                                    (ItemRelease.Item.Content.Rubriclist.Samplelist) jaxbElement.getValue();

                            for (ItemRelease.Item.Content.Rubriclist.Samplelist.Sample sample : samplelist.getSample()) {
                                if (StringUtils.isNotBlank(sample.getSamplecontent())) {
                                    String iatExemplar = mapRichTextContent(sample.getSamplecontent(),
                                            content.getApipAccessibility(), mappingProperties).getContent();
                                    saItem.getTranslations().getEsp().getExemplarResponses().add(iatExemplar);
                                }
                            }
                        }
                    }
                }
            }

            // Process attachments
            processAttachments(content, saItem, itemSourceFullPath, itemDestinationFullPath, mappingResult);
        }

        //Process Image Resources
        processImageResources(mappingProperties, saItem, itemSourceFullPath, itemDestinationFullPath, mappingResult);


        return saItem;
    }
}
