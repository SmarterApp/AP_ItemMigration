package org.opentestsystem.ap.migration.mapper;

import lombok.NoArgsConstructor;
import org.apache.commons.lang.StringUtils;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.model.StimItem;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.opentestsystem.ap.common.saaif.metadata.SmarterAppMetadata;
import org.opentestsystem.ap.migration.model.ItemMappingProperties;
import org.opentestsystem.ap.migration.model.ItemProps;
import org.opentestsystem.ap.migration.model.ItemMappingResult;

import java.nio.file.Path;

@NoArgsConstructor
public class StimModelMapper extends IatModelMapper {

    @Override
    public Item mapContent(Item item,
                    ItemRelease release,
                    Path itemLocalPath,
                    String itemSourceFullPath,
                    ItemMappingResult mappingResult) {
        StimItem stimItem = (StimItem) item;
        String itemDestinationFullPath = itemLocalPath.toString();

        ItemMappingProperties mappingProperties = new ItemMappingProperties();
        for (ItemRelease.Passage.Content content : release.getPassage().getContent()) {
            if (content.getLanguage().equals(ItemConstants.ItemLanguage.LANG_ENU)) {
                String passageText = getTitle(content) + content.getStem();
                mappingProperties = mapRichTextContent(passageText, content.getApipAccessibility(), mappingProperties);
                stimItem.getCore().getEn().setContent(mappingProperties.getContent());
            } else if (content.getLanguage().equals(ItemConstants.ItemLanguage.LANG_ESN)) {
                String passageText = getTitle(content) + content.getStem();
                mappingProperties = mapRichTextContent(getEsnContent(passageText), content.getApipAccessibility(), mappingProperties);
                stimItem.getTranslations().getEsp().setIsRequired("true");
                stimItem.getTranslations().getEsp().setProvided(true);
                stimItem.getTranslations().getEsp().setContent(mappingProperties.getContent());
            }

            // Process attachments
            processAttachments(content, stimItem, itemSourceFullPath, itemDestinationFullPath, mappingResult);
        }

        //Process Audio Resources
        processAudioResources(mappingProperties, stimItem, itemSourceFullPath, itemDestinationFullPath, mappingResult);

        //Process Image Resources
        processImageResources(mappingProperties, stimItem, itemSourceFullPath, itemDestinationFullPath, mappingResult);

        return stimItem;
    }

    @Override
    public Item mapMetadata(Item item, SmarterAppMetadata metadata) {
        StimItem stimItem = (StimItem) item;
        stimItem.getCore().setMetadata(mapItemMetadata(metadata));
        return stimItem;
    }

    @Override
    Item mapAssociatedPassage(Item item, ItemProps itemProps) {
        return item;
    }

    @Override
    Item mapTutorial(Item item, ItemProps itemProps) {
        return item;
    }

    private String getTitle(ItemRelease.Passage.Content content) {
        if(StringUtils.isBlank(content.getTitle())) {
            return StringUtils.EMPTY;
        }

        return "<p>" + content.getTitle() + "</p><p>&nbsp;</p>";
    }
}
