package org.opentestsystem.ap.migration.datastore;

import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.common.datastore.entity.ItemEntity;
import org.opentestsystem.ap.common.exception.SystemException;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.model.SkipMigration;
import org.opentestsystem.ap.migration.util.SpringUtil;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

import static org.apache.commons.collections4.ListUtils.emptyIfNull;

@Slf4j
public class DataStoreMigrationSetHandler {

    private final ApplicationProperties applicationProperties;

    private final ApplicationProperties.DataStoreProperties dataStoreMigrations;

    private final DataStoreDataManager dataManager;

    private final SpringUtil springUtil;

    public DataStoreMigrationSetHandler(ApplicationProperties applicationProperties,
                                        DataStoreDataManager dataManager,
                                        SpringUtil springUtil) {
        this.applicationProperties = applicationProperties;
        this.dataManager = dataManager;
        this.dataStoreMigrations = applicationProperties.getDataStoreMigrations();
        this.springUtil = springUtil;
    }

    /**
     * This is where an item is migrated within a transaction.  If there is a failure when migrating the item for this
     * set it should halt the migrations for the item.  The item migration handler will not call any more migration sets
     * for the item and instead will move to the next item.
     * <p>
     * Completion of this method means the item migration was successfully committed to the data store and event
     * messages were fired, events like regenerating the SAAIF in the item bank.
     * </p>
     *
     * @param entity       The entity to migrate
     * @param migrationSet The migration set
     * @param result       The result of the migration
     * @return The migrated master record, it represents the final migrated state for the item.
     */
    @Transactional
    public ItemEntity migrateItem(ItemEntity entity,
                                  ApplicationProperties.MigrationSet migrationSet,
                                  DataStoreItemResult result) {
        ItemEntity migratedEntity = entity;

        String migrationSetVersion = migrationSet.getMigrationSetKey();

        List<ApplicationProperties.MigrationDefinition> migrations = emptyIfNull(
                migrationSet.getMigrationDefinitions());

        for (ApplicationProperties.MigrationDefinition migrationDefinition : migrations) {
            try {
                DataStoreMigration migration = this.getDataStoreMigration(migrationDefinition.getMigrationName());

                migratedEntity = migration.migrate(migratedEntity, migrationSetVersion, migrationDefinition, result);

                String successMessage = String.format("item %s | set %s | migration %s",
                        entity.getItemId(),
                        migrationSetVersion,
                        migrationDefinition.getMigrationName());

                result.addSuccessMessage(successMessage);
            } catch (SkipMigration e) {
                String skipMessage = String.format("item %s | set %s | migration %s - %s",
                        entity.getItemId(),
                        migrationSetVersion,
                        migrationDefinition.getMigrationName(),
                        ExceptionUtils.getRootCauseMessage(e));
                result.addSuccessMessage(skipMessage);
            } catch (SystemException e) {
                throw e;
            } catch (Exception e) {
                throw new SystemException(e);
            }
        }

        return migratedEntity;
    }

    public DataStoreMigration getDataStoreMigration(final String migrationName) {
        final DataStoreMigration migration = springUtil.getDataStoreMigration(migrationName);
        if (migration == null) {
            throw new SystemException("No migration exists for data store migration " + migrationName);
        }
        return migration;
    }
}
