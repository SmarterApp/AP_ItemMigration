package org.opentestsystem.ap.migration.datastore;

import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.common.datastore.entity.ItemEntity;
import org.opentestsystem.ap.common.exception.ResourceNotFoundException;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.saaif.util.ImportFileUtil;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.model.FailedMigrationException;

import java.util.List;
import java.util.Objects;
import java.util.concurrent.atomic.AtomicInteger;

import static java.lang.String.format;
import static org.apache.commons.collections4.ListUtils.emptyIfNull;
import static org.opentestsystem.ap.common.model.ItemConstants.BranchNames.BRANCH_MASTER;

@Slf4j
public class DataStoreItemMigrationHandler {

    private static final AtomicInteger COUNTER = new AtomicInteger();

    private final ApplicationProperties applicationProperties;

    private final DataStoreDataManager dataManager;

    private final DataStoreMigrationSetHandler setHandler;

    public DataStoreItemMigrationHandler(ApplicationProperties applicationProperties,
                                         DataStoreDataManager dataManager,
                                         DataStoreMigrationSetHandler setHandler) {
        this.applicationProperties = applicationProperties;
        this.setHandler = setHandler;
        this.dataManager = dataManager;
    }

    public DataStoreItemResult migrate(String itemId) {
        log.info("Begin migration process for item {}", itemId);
        DataStoreItemResult result = new DataStoreItemResult(itemId);

        ItemEntity entityMaster = findMaster(itemId);
        Item item = entityMaster.getItemJson();

        String currentVersion = item.getVersion();
        ApplicationProperties.MigrationSet migrationSet = this.getNextDataStoreMigrationSet(currentVersion, true);

        if (Objects.nonNull(migrationSet)) {
            try {
                while (Objects.nonNull(migrationSet)) {
                    if (migrationSet.isIgnoreImportedItemsWithEdits()
                        && ImportFileUtil.isImported(entityMaster.getItemJson())
                        && dataManager.doesItemHaveEdits(entityMaster.getItemId())) {
                        log.info("IGNORE_EDIT_ITEMS: Not running migration set {} for item {} because the imported item has edits",
                            migrationSet.getMigrationSetKey(),
                            entityMaster.getItemId());
                        // get next migration before continuing
                        migrationSet = this.getNextDataStoreMigrationSet(migrationSet.getMigrationSetKey(), false);
                        continue;
                    }
                    setHandler.migrateItem(entityMaster, migrationSet, result);
                    migrationSet = this.getNextDataStoreMigrationSet(migrationSet.getMigrationSetKey(), false);
                }
            } catch (FailedMigrationException e) {
                log.error("Failed to run migration", e);
            } catch (Exception e) {
                String errorMsg = format("unexpected | item %s | set key %s | - %s",
                    itemId, migrationSet.getMigrationSetKey(), ExceptionUtils.getRootCauseMessage(e));
                log.error("Unexpected Exception", e);
                result.addFailedMessage(errorMsg);
            }
        } else {
            String message = format(
                "current | item %s | version %s - item is current, nothing to migrate",
                item.getId(), BRANCH_MASTER, currentVersion
            );
            result.addSuccessMessage(message);
        }
        log.info("End migration process for item {} - COUNT {}", itemId, COUNTER.incrementAndGet());
        return result;
    }

    // ------------------------------------------------------------------------

    private ApplicationProperties.MigrationSet getNextDataStoreMigrationSet(String currenSetKey,
                                                                            boolean defaultToStart) {
        ApplicationProperties.MigrationSet setToFind = new ApplicationProperties.MigrationSet(currenSetKey);

        List<ApplicationProperties.MigrationSet> migrationSets =
            emptyIfNull(applicationProperties.getDataStoreMigrations().getMigrationSets());

        int index = migrationSets.indexOf(setToFind);

        if (defaultToStart && index == -1) {
            return migrationSets.get(0);
        }

        return (index > -1 && index + 1 < migrationSets.size()) ? migrationSets.get(index + 1) : null;
    }

    private ItemEntity findMaster(String itemId) {
        ItemEntity entityMaster = this.dataManager.findLastMasterCommit(itemId);
        if (Objects.isNull(entityMaster)) {
            entityMaster = this.dataManager.findLastMaster(itemId);
        }
        this.checkResourceNotFound(entityMaster, itemId);
        return entityMaster;
    }

    private void checkResourceNotFound(ItemEntity entity, String itemId) {
        if (Objects.isNull(entity)) {
            throw new ResourceNotFoundException("Item " + itemId + " does not exist");
        }
    }
}
