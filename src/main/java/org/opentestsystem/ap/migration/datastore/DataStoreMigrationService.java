package org.opentestsystem.ap.migration.datastore;

import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.repository.ReportRepository;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
public class DataStoreMigrationService {

    private final ApplicationProperties applicationProperties;

    private final ApplicationProperties.DataStoreProperties dataStoreMigrations;

    private final DataStoreDataManager dataManager;

    private final DataStoreItemMigrationHandler itemMigrationHandler;

    private final ReportRepository reportRepository;

    public DataStoreMigrationService(ApplicationProperties applicationProperties,
                                     DataStoreDataManager dataManager,
                                     DataStoreItemMigrationHandler itemMigrationHandler,
                                     ReportRepository reportRepository) {
        this.applicationProperties = applicationProperties;
        this.dataStoreMigrations = applicationProperties.getDataStoreMigrations();
        this.dataManager = dataManager;
        this.itemMigrationHandler = itemMigrationHandler;
        this.reportRepository = reportRepository;
    }

    /**
     * Executes the migration process against an itembank.
     */
    public void migrate() {
        // are migrations enabled
        if (dataStoreMigrations.isEnabled()) {
            log.info("data store migrations are enabled");

            DataStoreMigrationReport migrationReport = new DataStoreMigrationReport().startMigrationTimer();

            // get the items to migrateAndSave, if there are included items then only the included items are migrated
            List<String> itemIds = this.getItemsToMigrate();

            // migrate items, async here to migrate items in parallel
            List<DataStoreItemResult> results = itemIds.stream()
                .map(this.itemMigrationHandler::migrate)
                .collect(Collectors.toList());

            migrationReport
                .setItemsToProcessCount(itemIds.size())
                .setItemResults(results)
                .stopMigrationTimer();

            publish(migrationReport);

            log.info("migration complete");
        } else {
            log.info("migration is disabled");
        }
    }

    // ------------------------------------------------------------------------

    private List<String> getItemsToMigrate() {
        List<String> itemIds = this.applicationProperties.getIncludedItems();
        return CollectionUtils.isEmpty(itemIds) ? this.dataManager.findActiveItemIds() : itemIds;
    }

    private void publish(DataStoreMigrationReport migrationReport) {
        if (applicationProperties.isPublishReportEnabled()) {
            try {
                reportRepository.publishReport(migrationReport);
                reportRepository.deleteLocalReportRepository();
            } catch (Exception e) {
                log.error("The migration report failed to publish to the ItemBank", e);
            }
        }
    }
}
