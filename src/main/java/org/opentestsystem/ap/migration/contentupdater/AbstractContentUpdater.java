package org.opentestsystem.ap.migration.contentupdater;

import org.apache.commons.lang3.StringUtils;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemOption;
import org.opentestsystem.ap.common.model.Table;

import java.util.List;
import java.util.Objects;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicReference;

import static java.util.Collections.emptyList;
import static org.opentestsystem.ap.common.model.ModelConstants.ItemLanguage.LANG_ESN;

public abstract class AbstractContentUpdater<T extends Item> implements ContentUpdater<T> {

    protected static final boolean LABELS_ONLY = true;

    protected boolean contentChanged = false;

    protected abstract boolean updateEnglishContent(T item, ContentUpdateCommand contentUpdateCommand);

    protected abstract boolean updateSpanishContent(T item, ContentUpdateCommand contentUpdateCommand);

    @Override
    public void updateContent(T item, ContentUpdateCommand contentUpdateCommand) {
        boolean englishChanged = updateEnglishContent(item, contentUpdateCommand);
        boolean spanishChanged = updateSpanishContent(item, contentUpdateCommand);

        this.contentChanged = englishChanged || spanishChanged;
    }

    @Override
    public boolean contentChanged() {
        return this.contentChanged;
    }

    protected boolean updateSpanishItemOptions(List<ItemOption> spanishOptions,
                                               List<ItemOption> englishOptions,
                                               ContentUpdateCommand updateCommand) {
        boolean isContentChanged = false;
        for (int i = 0; i < spanishOptions.size(); ++i) {
            ItemOption english = this.indexOf(englishOptions, i);
            ItemOption spanish = spanishOptions.get(i);
            ContentUpdateCommandResult commandResult = updateCommand.applyTranslatedContentUpdate(
                    LANG_ESN,
                    spanish.getRationale(),
                    Objects.nonNull(english) ? english.getRationale() : StringUtils.EMPTY);
            spanish.setRationale(commandResult.getUpdatedContent());
            isContentChanged = isContentChanged || commandResult.isContentChanged();

            commandResult = updateCommand.applyTranslatedContentUpdate(
                    LANG_ESN, spanish.getText(),
                    Objects.nonNull(english) ? english.getText() : StringUtils.EMPTY);
            spanish.setText(commandResult.getUpdatedContent());
            isContentChanged = isContentChanged || commandResult.isContentChanged();
        }
        return isContentChanged;
    }

    protected boolean updateEnglishTable(Table table, ContentUpdateCommand updateCommand, boolean labelsOnly) {
        AtomicReference<ContentUpdateCommandResult> commandResult = new AtomicReference<>();
        AtomicBoolean isContentChanged = new AtomicBoolean(false);
        table.getColumns().forEach(column -> {
            commandResult.set(updateCommand.applyEnglishContentUpdate(column.getLabel()));
            column.setLabel(commandResult.get().getUpdatedContent());
            isContentChanged.set(isContentChanged.get() || commandResult.get().isContentChanged());
        });

        table.getRows().forEach(row -> {
            row.getCells().forEach(cell -> {
                if (!labelsOnly || cell.isLabel()) {
                    commandResult.set(updateCommand.applyEnglishContentUpdate((String) cell.getValue()));
                    cell.setValue(commandResult.get().getUpdatedContent());
                    isContentChanged.set(isContentChanged.get() || commandResult.get().isContentChanged());
                }
            });
        });
        return isContentChanged.get();
    }

    protected boolean updateSpanishTableColumns(List<Table.Column> spanishColumns,
                                                List<Table.Column> englishColumns,
                                                ContentUpdateCommand updateCommand) {
        AtomicReference<ContentUpdateCommandResult> commandResult = new AtomicReference<>();
        AtomicBoolean isContentChanged = new AtomicBoolean(false);
        for (int i = 0; i < spanishColumns.size(); ++i) {
            Table.Column spanishColumn = spanishColumns.get(i);
            Table.Column englishColumn = this.indexOf(englishColumns, i);
            commandResult.set(updateCommand.applyTranslatedContentUpdate(
                    LANG_ESN,
                    spanishColumn.getLabel(),
                    Objects.nonNull(englishColumn) ? englishColumn.getLabel() : StringUtils.EMPTY));
            spanishColumn.setLabel(commandResult.get().getUpdatedContent());
            isContentChanged.set(isContentChanged.get() || commandResult.get().isContentChanged());
        }
        return isContentChanged.get();
    }

    protected boolean updateSpanishTableRows(List<Table.Row> spanishRows,
                                             List<Table.Row> englishRows,
                                             ContentUpdateCommand updateCommand,
                                             boolean labelsOnly) {
        boolean isContentChanged = false;
        for (int i = 0; i < spanishRows.size(); ++i) {
            Table.Row spanishRow = spanishRows.get(i);
            Table.Row englishRow = this.indexOf(englishRows, i);

            List<Table.Cell> spanishCells = Objects.nonNull(spanishRow) ? spanishRow.getCells() : emptyList();
            List<Table.Cell> englishCells = Objects.nonNull(englishRow) ? englishRow.getCells() : emptyList();

            boolean tableCellsChanged = this.updateSpanishTableCells(spanishCells, englishCells, updateCommand, labelsOnly);
            isContentChanged = isContentChanged || tableCellsChanged;
        }
        return isContentChanged;
    }

    protected boolean updateSpanishTableCells(List<Table.Cell> spanishCells,
                                              List<Table.Cell> englishCells,
                                              ContentUpdateCommand updateCommand,
                                              boolean labelsOnly) {
        AtomicReference<ContentUpdateCommandResult> commandResult = new AtomicReference<>();
        AtomicBoolean isContentChanged = new AtomicBoolean(false);
        for (int i = 0; i < spanishCells.size(); ++i) {
            Table.Cell spanishCell = spanishCells.get(i);
            if (Objects.nonNull(spanishCell) && (!labelsOnly || spanishCell.isLabel())) {
                Table.Cell englishCell = this.indexOf(englishCells, i);
                commandResult.set(updateCommand.applyTranslatedContentUpdate(
                        LANG_ESN,
                        (String) spanishCell.getValue(),
                        Objects.nonNull(englishCell) ? (String) englishCell.getValue() : StringUtils.EMPTY));

                spanishCell.setValue(commandResult.get().getUpdatedContent());
                isContentChanged.set(isContentChanged.get() || commandResult.get().isContentChanged());
            }
        }
        return isContentChanged.get();
    }

    protected boolean updateSpanishListOfStrings(List<String> spanishList,
                                                 List<String> englishList,
                                                 ContentUpdateCommand updateCommand) {
        ContentUpdateCommandResult commandResult;
        boolean isContentChanged = false;
        for (int i = 0; i < spanishList.size(); ++i) {
            String spanish = spanishList.get(i);
            String english = this.indexOf(englishList, i);
            commandResult = updateCommand.applyTranslatedContentUpdate(LANG_ESN, spanish, english);
            spanishList.set(i, commandResult.getUpdatedContent());
            isContentChanged = isContentChanged || commandResult.isContentChanged();
        }
        return isContentChanged;
    }

    protected <R> R indexOf(List<R> list, int i) {
        return (Objects.nonNull(list) && i < list.size()) ? list.get(i) : null;
    }

    protected boolean contentChanged(String previous, String current) {
        return !previous.equals(current);
    }
}
