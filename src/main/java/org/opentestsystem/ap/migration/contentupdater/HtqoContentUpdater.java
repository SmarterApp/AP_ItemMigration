package org.opentestsystem.ap.migration.contentupdater;

import org.opentestsystem.ap.common.model.HtqoItem;
import org.opentestsystem.ap.common.model.content.HtqoItemContent;

import java.util.List;

import static org.opentestsystem.ap.common.model.ItemConstants.ItemLanguage.LANG_ESN;

public class HtqoContentUpdater extends AbstractContentUpdater<HtqoItem> {

    @Override
    protected void updateEnglishContent(HtqoItem item, ContentUpdateCommand updateCommand) {
        HtqoItemContent englishContent = item.getCore().getEn();
        englishContent.setPrompt(updateCommand.applyEnglishContentUpdate(englishContent.getPrompt()));
        englishContent.getHtqOrderable().getOrderableStrings().replaceAll(updateCommand::applyEnglishContentUpdate);

        item.getCore().getScoring().setRubric(
            updateCommand.applyEnglishContentUpdate(item.getCore().getScoring().getRubric()));
    }

    @Override
    protected void updateSpanishContent(HtqoItem item, ContentUpdateCommand updateCommand) {
        HtqoItemContent englishContent = item.getCore().getEn();
        HtqoItemContent spanishContent = item.getTranslations().getEsp();

        spanishContent.setPrompt(
            updateCommand.applyTranslatedContentUpdate(
                LANG_ESN,
                spanishContent.getPrompt(),
                englishContent.getPrompt()
            )
        );

        updateSpanishOrderables(
            spanishContent.getHtqOrderable().getOrderableStrings(),
            englishContent.getHtqOrderable().getOrderableStrings(),
            updateCommand);
    }

    private void updateSpanishOrderables(List<String> spanishOrderables,
                                         List<String> englishOrderables,
                                         ContentUpdateCommand updateCommand) {
        for (int i = 0; i < spanishOrderables.size(); ++i) {
            String english = this.indexOf(englishOrderables, i);
            String spanish = spanishOrderables.get(i);
            spanishOrderables.set(i, updateCommand.applyTranslatedContentUpdate(LANG_ESN, spanish, english));
        }
    }
}
