package org.opentestsystem.ap.migration.migration

import lombok.extern.slf4j.Slf4j
import org.opentestsystem.ap.common.client.GitClient
import org.opentestsystem.ap.common.itembank.ItemBankSyncManager
import org.opentestsystem.ap.common.model.ItemTransaction
import org.opentestsystem.ap.migration.model.BranchInfo
import org.opentestsystem.ap.migration.model.ItemInfo
import org.opentestsystem.ap.migration.model.MigrationDefinition
import org.opentestsystem.ap.migration.util.Util
import org.springframework.stereotype.Component

@Slf4j
@Component
class Migration2170 extends AbstractMigration {

    final ItemBankSyncManager syncManager

    Migration2170(Util util, ItemBankSyncManager syncManager) {
        super(util)
        this.syncManager = syncManager
    }

    @Override
    protected void runMigration(ItemInfo itemInfo,
                                BranchInfo branchInfo,
                                MigrationDefinition migration,
                                GitClient gitClient) {
        ItemTransaction transaction = branchInfo.getTransaction()
        ItemTransaction syncTransaction = syncManager.generateSyncTransaction(itemInfo.itemId, transaction)
        branchInfo.syncResult = syncManager.syncToDataStore(gitClient, itemInfo.itemId, syncTransaction)
    }
}