package org.opentestsystem.ap.migration.datastore

import lombok.extern.slf4j.Slf4j
import org.gitlab4j.api.models.Project
import org.gitlab4j.api.models.RepositoryFile
import org.jsoup.Jsoup
import org.jsoup.nodes.Document
import org.opentestsystem.ap.common.assembler.AppAssembler
import org.opentestsystem.ap.common.client.GitlabClient
import org.opentestsystem.ap.common.datastore.DataStoreAttachmentManager
import org.opentestsystem.ap.common.datastore.DataStoreDataManager
import org.opentestsystem.ap.common.datastore.DataStoreUtility
import org.opentestsystem.ap.common.datastore.entity.ItemEntity
import org.opentestsystem.ap.common.gitlab.GitLabSyncManager
import org.opentestsystem.ap.common.management.ItemManagerEventProducer
import org.opentestsystem.ap.common.model.EbsrItem
import org.opentestsystem.ap.common.model.ItemConstants
import org.opentestsystem.ap.common.saaif.item.ItemRelease
import org.opentestsystem.ap.migration.ApplicationDependencyProvider
import org.opentestsystem.ap.migration.ApplicationProperties
import org.opentestsystem.ap.migration.mapper.IatModelMapper
import org.opentestsystem.ap.migration.mapper.IatModelMapperFactory
import org.opentestsystem.ap.migration.model.ItemMappingProperties
import org.opentestsystem.ap.migration.model.SkipMigration
import org.opentestsystem.ap.migration.util.MigrationFileUtil
import org.springframework.stereotype.Component

import java.nio.file.Files
import java.nio.file.Path
import java.nio.file.Paths

import static org.opentestsystem.ap.common.model.ItemConstants.BranchNames.BRANCH_MASTER

@Slf4j
@Component
class Migration2673 extends AbstractDataStoreMigration {
    private static final String MASTER_BRANCH = "master"

    private final GitlabClient gitlabClient
    private final AppAssembler appAssembler
    private final GitLabSyncManager itemBankSyncManager
    private final MigrationFileUtil migrationFileUtil
    private final IatModelMapperFactory iatModelMapperFactory;

    Migration2673(final ApplicationDependencyProvider applicationDependencyProvider,
                  final ApplicationProperties applicationProperties,
                  final DataStoreDataManager dataManager,
                  final ItemManagerEventProducer eventProducer,
                  final DataStoreUtility dataStoreUtility,
                  final DataStoreAttachmentManager dataStoreAttachmentManager,
                  final MigrationFileUtil migrationFileUtil,
                  final IatModelMapperFactory iatModelMapperFactory) {
        super(applicationProperties, dataManager, eventProducer, dataStoreUtility, dataStoreAttachmentManager)
        this.gitlabClient = applicationDependencyProvider.gitlabClient
        this.appAssembler = applicationDependencyProvider.appAssembler
        this.itemBankSyncManager = applicationDependencyProvider.itemBankSyncManager
        this.migrationFileUtil = migrationFileUtil
        this.iatModelMapperFactory = iatModelMapperFactory
    }

    @Override
    protected ItemEntity migrateEntity(ItemEntity itemEntity) {
        Optional<RepositoryFile> importZip = gitlabClient.lookUpFileOnMaster(itemEntity.getItemId(), MigrationFileUtil.IMPORT_ZIP_FILENAME)
        if (itemEntity.getItemJson().getType() != ItemConstants.ItemType.TYPE_EBSR) {
            throw new SkipMigration(String.format("Item %s is not EBSR type.  No updates necessary", itemEntity.getId()))
        }
        if (!importZip.isPresent()) {
            throw new SkipMigration(String.format("Item %s is not imported.  No updates necessary", itemEntity.getId()))
        }

        try {
            Project glProject = gitlabClient.lookupProjectByName(itemEntity.getItemJson().getId())
            if (glProject) {
                applyEbsrMigration(itemEntity, glProject)
            }
        } catch (Exception ex) {
            throw new SkipMigration(String.format("Unable to migrate item %s. %s", itemEntity.getId(), ex.message))
        }

        return itemEntity
    }

    private void applyEbsrMigration(ItemEntity itemEntity, Project project) {
        Path expandedZip = migrationFileUtil.getExpandedImportZipFile(itemEntity.getItemId(),
                gitlabClient.getFile(project.getId(), MigrationFileUtil.IMPORT_ZIP_FILENAME, MASTER_BRANCH))

        if (expandedZip.toFile().exists()) {
            //TODO: Identify item directory
            String itemSourceDir = expandedZip.resolve(String.format("%s-%s-%s", "Item", "200", itemEntity.getItemId()))
            String itemSyncDir = Files.createTempDirectory(itemEntity.getItemId())
            String itemFileName = String.format("%s-%s-%s/%s-%s-%s.xml", "Item", "200", itemEntity.getItemId(), "item", "200", itemEntity.getItemId());
            File itemFile = migrationFileUtil.getFile(itemFileName, expandedZip)

            final ItemRelease itemRelease = this.appAssembler.getSaaifAssembler()
                    .readXmlFromFile(itemFile.toPath())

            final IatModelMapper mapper = iatModelMapperFactory.newModelMapper(itemEntity.getItemJson().getType())

            Document itemBody = Jsoup.parseBodyFragment(itemRelease.getItem().getContent().get(0).qti.value, "UTF-8")
            String qtiFirstParagraph = itemBody.getElementsByTag("p").first().toString()

            EbsrItem ebsrItem = (EbsrItem) itemEntity.getItemJson()

            ItemMappingProperties mappingProperties = mapper.mapSingleRichTextContent(qtiFirstParagraph,
                    ebsrItem,
                    itemRelease.getItem().getContent().get(0).getApipAccessibility(),
                    itemSourceDir,
                    itemSyncDir)


            ebsrItem.getCore().getEn().setPrompt(mappingProperties.getContent())
            //TODO: add audio and image resources if found in mappingProperties

            itemEntity.setItemJson(ebsrItem)

            itemBankSyncManager.syncAttachmentsToDataStore(itemEntity.getItemId(), BRANCH_MASTER, Paths.get(itemSyncDir))
        }
    }
}
