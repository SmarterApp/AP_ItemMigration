package org.opentestsystem.ap.migration.datastore

import lombok.extern.slf4j.Slf4j
import org.opentestsystem.ap.common.datastore.DataStoreDataManager
import org.opentestsystem.ap.common.datastore.DataStoreEventProducer
import org.opentestsystem.ap.common.datastore.DataStoreUtility
import org.opentestsystem.ap.common.datastore.entity.ItemEntity
import org.opentestsystem.ap.migration.ApplicationProperties
import org.opentestsystem.ap.migration.model.SkipMigration

import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_EBSR

@Slf4j
class Migration2324 extends AbstractDataStoreMigration {

    Migration2324(ApplicationProperties applicationProperties,
                  DataStoreDataManager dataManager,
                  DataStoreEventProducer eventProducer,
                  DataStoreUtility dataStoreUtility) {
        super(applicationProperties, dataManager, eventProducer, dataStoreUtility)
    }

    @Override
    void migrateEntity(ItemEntity itemEntity) {
        if (!TYPE_EBSR.equalsIgnoreCase(itemEntity.getItemJson().getType())) {
            throw new SkipMigration("item $itemEntity.itemId is not EBSR")
        }
        if (itemEntity.isMaster() && itemEntity.isBeingEdited()) {
            throw new SkipMigration("item $itemEntity.itemId is being created")
        }
    }
}