package org.opentestsystem.ap.migration.mapper;

import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.model.TiItem;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.opentestsystem.ap.migration.model.ItemMappingResult;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;

import static org.assertj.core.api.Java6Assertions.assertThat;

public class TiModelMapperTest {
    private static final String sampleEnglishStemContent = "<p style=\"\">Mrs. Palmer’s class also needs <span id=\"item_29136_TAG_17\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"1\"></span>sandwiches<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_17\" data-tag-boundary=\"end\"></span> for the <span id=\"item_29136_TAG_18\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"2\"></span>field trip<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_18\" data-tag-boundary=\"end\"></span>.</p><p style=\"\">&#xA0;</p><p style=\"font-weight:bold; \"><span id=\"item_29136_TAG_16_BEGIN\">Table</span> 2. <span id=\"item_29136_TAG_19\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"1\"></span>Sandwiches<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_19\" data-tag-boundary=\"end\"></span> for Mrs. Palmer’s <span id=\"item_29136_TAG_5_BEGIN\">Class</span></p><p style=\"\">&#xA0;</p><div align=\"left\"><table class=\"newtable\" id=\"item_29136_Table5\" style=\"width:22.0002em; border-spacing:0;\" cellpadding=\"0\" cellspacing=\"0\"><colgroup style=\"width:8.1252em; \" /><colgroup style=\"width:13.8750em; \" /><tbody><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-top:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; font-weight:bold; \"><span id=\"item_29136_TAG_6_BEGIN\">Type</span> of <span id=\"item_29136_TAG_10_BEGIN\"><span id=\"item_29136_TAG_10\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"1\"></span>Sandwich<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_10\" data-tag-boundary=\"end\"></span></span></p></td><td style=\"vertical-align:middle; padding:0.2292em;  border:0.06em solid #000000;\"><p style=\"text-align:center; font-weight:bold; \">How Many Are <span id=\"item_29136_TAG_11_BEGIN\">Needed</span></p></td></tr><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span id=\"item_29136_TAG_7_BEGIN\">Cheese</span></p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span id=\"item_29136_TAG_12_BEGIN\">10</span></p></td></tr><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span id=\"item_29136_TAG_8_BEGIN\">Ham</span></p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span id=\"item_29136_TAG_13_BEGIN\">12</span></p></td></tr><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span id=\"item_29136_TAG_9_BEGIN\">Turkey</span></p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span id=\"item_29136_TAG_14_BEGIN\">8</span></p></td></tr></tbody></table></div><p style=\"\">&#xA0;</p><p style=\"\">Use the information in <span style=\"font-weight:bold; \">Table 1 Sandwiches</span> and <span style=\"font-weight:bold; \">Table 2 Sandwiches for Mrs. Palmer’s Class.</span></p><p style=\"\">&#xA0;</p><p style=\"\"><span id=\"item_29136_TAG_20\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"3\"></span>Enter<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_20\" data-tag-boundary=\"end\"></span> how many of each <span id=\"item_29136_TAG_21\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"4\"></span>type<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_21\" data-tag-boundary=\"end\"></span> of sandwich are needed for the field trip and find the total number of <span id=\"item_29136_TAG_15_BEGIN\"><span id=\"item_29136_TAG_15\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"1\"></span>sandwiches.<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_15\" data-tag-boundary=\"end\"></span></span></p><div align=\"left\"><table class=\"tableItem\" style=\"width:21.166800000000002em; border-spacing:0;\" cellpadding=\"0\" cellspacing=\"0\"><colgroup style=\"width:13.8750em; \" /><colgroup style=\"width:7.2918em; \" /><thead><tr><th data-its-identifier=\"col0\" style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-top:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; font-weight:bold; \">Question</p></th><th data-its-identifier=\"col1\" style=\"vertical-align:middle; padding:0.2292em;  border:0.06em solid #000000;\"><p style=\"text-align:center; font-weight:bold; \">Answer</p></th></tr></thead><tbody><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"\">How many <span style=\"font-weight:bold; \">Cheese</span> sandwiches are needed?</p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"numericOnly\">_</span></p></td></tr><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"\">How many <span style=\"font-weight:bold; \">Ham</span> sandwiches are needed?</p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"numericOnly\">_</span></p></td></tr><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"\">How many <span style=\"font-weight:bold; \">Turkey</span> sandwiches are needed?</p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"numericOnly\">_</span></p></td></tr><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"\">What is the total number of sandwiches needed?</p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"numericOnly\">_</span></p></td></tr></tbody></table></div>";
    private static final String sampleSpanishStemContent = "<p style=\"\"><span style=\"color:; language:pt; country:BR; \">En una escuela primaria hay un total</span><span style=\"\"> </span><span style=\"language:pt; country:BR; \">de 500 estudiantes en los grados primero al quinto.</span> </p><p style=\"\">&#xA0;</p><ul style=\"padding-left:1.5000em; \"><li><p style=\"language:pt; country:BR; \">17% del número total de estudiantes están en 1er grado.</p></li><li><p style=\"language:pt; country:BR; \">19% del número total de estudiantes están en 4to grado. </p></li><li><p style=\"\"><span style=\"language:pt; country:BR; \">El número de estudiantes de 3er grado es 9 menos que el número de estudiantes de 4to grado.</span> </p></li><li><p style=\"\"><span style=\"language:pt; country:BR; \">El número de estudiantes de 2do grado es 10 menos que el número de estudiantes de 5to grado.</span> </p><p style=\"\">&#xA0;</p></li></ul><p style=\"language:pt; country:BR; \">Completa la tabla para mostrar el número de estudiantes en cada grado. Escribe tus respuestas en la tabla.</p><p style=\"\">&#xA0;</p><p style=\"font-weight:bold; \">Estudiantes de la escuela primaria</p><p class=\"languagedivider\">&#xA0;</p><p style=\"\"><span style=\"color:; language:pt; country:BR; \">There are a </span><span id=\"item_83157_TAG_12\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"1\"></span><span style=\"color:; language:pt; country:BR; \">total</span><span class=\"its-tag\" data-tag-ref=\"item_83157_TAG_12\" data-tag-boundary=\"end\"></span><span style=\"\"> </span><span style=\"language:pt; country:BR; \">of </span><span id=\"item_83157_TAG_7_BEGIN\"><span style=\"language:pt; country:BR; \">500</span></span><span style=\"language:pt; country:BR; \"> students in grades 1 through 5 in an elementary school.</span> </p><p style=\"\">&#xA0;</p><ul style=\"padding-left:1.5000em; \"><li><p style=\"language:pt; country:BR; \"><span id=\"item_83157_TAG_8_BEGIN\">17%</span> of the <span id=\"item_83157_TAG_13\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"1\"></span>total<span class=\"its-tag\" data-tag-ref=\"item_83157_TAG_13\" data-tag-boundary=\"end\"></span> number of students are in 1st grade.</p></li><li><p style=\"language:pt; country:BR; \"><span id=\"item_83157_TAG_9_BEGIN\">19%</span> of the <span id=\"item_83157_TAG_14\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"1\"></span>total<span class=\"its-tag\" data-tag-ref=\"item_83157_TAG_14\" data-tag-boundary=\"end\"></span> number of students are in 4th grade. </p></li><li><p style=\"\"><span style=\"language:pt; country:BR; \">The number of 3rd-grade students is 9 less than the number of 4th-grade students.</span> </p></li><li><p style=\"\"><span style=\"language:pt; country:BR; \">The number of 2nd-grade students is 10 less than the number of 5th-grade students.</span> </p><p style=\"\">&#xA0;</p></li></ul><p style=\"language:pt; country:BR; \"><span id=\"item_83157_TAG_15\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"2\"></span>Complete<span class=\"its-tag\" data-tag-ref=\"item_83157_TAG_15\" data-tag-boundary=\"end\"></span> the table to show the number of students in <span id=\"item_83157_TAG_16\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"3\"></span>each<span class=\"its-tag\" data-tag-ref=\"item_83157_TAG_16\" data-tag-boundary=\"end\"></span> grade. <span id=\"item_83157_TAG_17\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"4\"></span>Enter<span class=\"its-tag\" data-tag-ref=\"item_83157_TAG_17\" data-tag-boundary=\"end\"></span> your answers in the <span id=\"item_83157_TAG_10_BEGIN\">table.</span></p><p style=\"\">&#xA0;</p><p style=\"font-weight:bold; \">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span id=\"item_83157_TAG_11_BEGIN\">Elementary School Students</span></p><div align=\"left\"><table class=\"tableItem\" style=\"width:14.4168em; border-spacing:0;\" cellpadding=\"0\" cellspacing=\"0\"><colgroup style=\"width:7.7916em; \" /><colgroup style=\"width:6.6252em; \" /><thead><tr><th scope=\"col\" data-its-identifier=\"col0\" style=\"padding:0.2292em;  border-left:0.06em solid #000000; border-top:0.06em solid #000000; border-bottom:0.06em solid #000000;vertical-align:top; \"><p style=\"text-align:center; font-weight:bold; \">Grado</p><p class=\"languagedivider\">&#xA0;</p><p style=\"text-align:center; font-weight:bold; \">Grade</p></th><th scope=\"col\" data-its-identifier=\"col1\" style=\"padding:0.2292em;  border:0.06em solid #000000;vertical-align:top; \"><p style=\"text-align:center; font-weight:bold; \">Número de estudiantes</p><p class=\"languagedivider\">&#xA0;</p><p style=\"text-align:center; font-weight:bold; \">Number of Students</p></th></tr></thead><tbody><tr><td style=\"padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;vertical-align:top; \"><p style=\"text-align:center; \">1ro</p><p class=\"languagedivider\">&#xA0;</p><p style=\"text-align:center; \">1st</p></td><td style=\"padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;vertical-align:top; \"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"None\">_</span></p></td></tr><tr><td style=\"padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;vertical-align:top; \"><p style=\"text-align:center; \">2do</p><p class=\"languagedivider\">&#xA0;</p><p style=\"text-align:center; \">2nd</p></td><td style=\"padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;vertical-align:top; \"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"None\">_</span></p></td></tr><tr><td style=\"padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;vertical-align:top; \"><p style=\"text-align:center; vertical-align: 0%;font-size: 100%;\">3ro</p><p class=\"languagedivider\">&#xA0;</p><p style=\"text-align:center; vertical-align: 0%;font-size: 100%;\">3rd</p></td><td style=\"padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;vertical-align:top; \"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"None\">_</span></p></td></tr><tr><td style=\"padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;vertical-align:top; \"><p style=\"text-align:center; \">4to</p><p class=\"languagedivider\">&#xA0;</p><p style=\"text-align:center; \">4th</p></td><td style=\"padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;vertical-align:top; \"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"None\">_</span></p></td></tr><tr><td style=\"padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;vertical-align:top; \"><p style=\"text-align:center; \">5to</p><p class=\"languagedivider\">&#xA0;</p><p style=\"text-align:center; \">5th</p></td><td style=\"padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;vertical-align:top; \"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"None\">_</span></p></td></tr></tbody></table></div>";
    private TiModelMapper tiModelMapper;

    @Before
    public void setUp() {
        tiModelMapper = new TiModelMapper();
    }

    @Test
    public void shouldRemoveInteractiveTableFromPrompt() throws IOException {
        ItemRelease itemRelease = new ItemRelease();
        ItemRelease.Item item = new ItemRelease.Item();
        ItemRelease.Item.Content content = new ItemRelease.Item.Content();
        content.setStem(sampleEnglishStemContent);
        content.setLanguage(ItemConstants.ItemLanguage.LANG_ENU);
        item.getContent().add(content);
        itemRelease.setItem(item);

        TiItem tiItem = new TiItem("123");
        Path tempDir = Files.createTempDirectory("TiModelMapperTest_temp");
        Path itemDir = Files.createTempDirectory("TiModelMapperTest_item");
        ItemMappingResult mappingResult = new ItemMappingResult();

        TiItem mappedItem = (TiItem) tiModelMapper.mapContent(tiItem, itemRelease, tempDir, itemDir.toString(), mappingResult);

        assertThat(mappedItem.getCore().getEn().getTable()).isNotNull();
        assertThat(mappedItem.getCore().getEn().getTable().getRows()).isNotEmpty();
        assertThat(mappedItem.getCore().getEn().getPrompt()).doesNotContain("<table class=\"tableItem\"");
        assertThat(mappedItem.getCore().getEn().getPrompt()).contains("<td><p style=\"text-align:center; \"><span id=\"item_29136_TAG_7_BEGIN\">Cheese</span></p></td>");
    }

    @Test
    public void shouldRemoveEnglishFromSpanishText() throws IOException {
        ItemRelease itemRelease = new ItemRelease();
        ItemRelease.Item item = new ItemRelease.Item();
        ItemRelease.Item.Content content = new ItemRelease.Item.Content();
        content.setStem(sampleSpanishStemContent);
        content.setLanguage(ItemConstants.ItemLanguage.LANG_ESN);
        item.getContent().add(content);
        itemRelease.setItem(item);

        TiItem tiItem = new TiItem("123");
        Path tempDir = Files.createTempDirectory("TiModelMapperTest_temp");
        Path itemDir = Files.createTempDirectory("TiModelMapperTest_item");
        ItemMappingResult mappingResult = new ItemMappingResult();

        TiItem mappedItem = (TiItem) tiModelMapper.mapContent(tiItem, itemRelease, tempDir, itemDir.toString(), mappingResult);

        assertThat(mappedItem.getTranslations().getEsp().getPrompt()).doesNotContain("The number of 2nd-grade students is 10 less than the number of 5th-grade students.");
    }
}