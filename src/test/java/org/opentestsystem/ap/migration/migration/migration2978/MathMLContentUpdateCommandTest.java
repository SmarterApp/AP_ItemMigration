package org.opentestsystem.ap.migration.migration.migration2978;

import org.apache.commons.lang3.StringUtils;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.ap.common.model.Attachment;
import org.opentestsystem.ap.common.model.ItemImageResource;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Arrays;
import java.util.Date;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.ap.common.model.ItemConstants.ItemLanguage.LANG_ESN;
import static org.opentestsystem.ap.common.model.ItemConstants.Section.SECTION_IMAGES;

public class MathMLContentUpdateCommandTest {

    static final String EQUATION_PNG = "mathml.png";
    static final String EQUATION_MATH_ML = "mathml.xml";

    static final String MATHML_CONTENT = "<math xmlns:math=\"http://www.w3.org/1998/Math/MathML\"><mrow><mn>1</mn></mrow></math>";

    static final String IMAGE_RESOURCE_CONTENT = "<img data-iat-image-resource-id=\"1\"/>";

    MathMLContentUpdateCommand command;

    Path itemSyncDir;

    List<ItemImageResource> imageResources;

    @Before
    public void setup() throws IOException {
        this.initSynFolder();
        this.initMathMLData();
        this.initImageResources();
        this.command = new MathMLContentUpdateCommand(this.imageResources, this.itemSyncDir);
    }

    @Test
    public void testApplyContentUpdate() {
        String expectedContent = "<span class=\"tts\"><math xmlns:math=\"http://www.w3.org/1998/Math/MathML\"><mrow><mn>1</mn></mrow></math> </span>";

        String actualContent = this.command
            .applyEnglishContentUpdate("<span class=\"tts\">" + IMAGE_RESOURCE_CONTENT + "</span>");

        assertThat(actualContent).isEqualTo(expectedContent);
    }

    @Test
    public void testApplyContentUpdateToSpanishWhenThereIsNoMathMLMatch() {
        String expectedContent = "<span><math xmlns:math=\"http://www.w3.org/1998/Math/MathML\"><mrow><mn>1</mn></mrow></math> </span>";

        String englishContent = this.command
            .applyEnglishContentUpdate("<span class=\"tts\">" + IMAGE_RESOURCE_CONTENT + "</span>");

        String actualContent = this.command
            .applyTranslatedContentUpdate(LANG_ESN, "<span>" + IMAGE_RESOURCE_CONTENT + "</span>", englishContent);

        assertThat(actualContent).isEqualTo(expectedContent);
    }

    @Test
    public void testApplyContentUpdateToSpanishWhenThereIsAMathMLMatch() {
        String englishContent = this.command
            .applyEnglishContentUpdate("<span class=\"tts\">" + IMAGE_RESOURCE_CONTENT + "</span>");

        String actualContent = this.command
            .applyTranslatedContentUpdate(LANG_ESN, IMAGE_RESOURCE_CONTENT, englishContent);

        assertThat(actualContent).isEqualTo(StringUtils.EMPTY);
    }

    @Test
    public void testMathMLMatchBetweenSpanishContentAndEnglishContent() {
        String spanish = MATHML_CONTENT;
        String english = "<span class=\"tts\">" + MATHML_CONTENT + "</span>";
        assertThat(this.command.isMathMLMatch(spanish, english)).isTrue();

        spanish = "Not mathml " + MATHML_CONTENT;
        assertThat(this.command.isMathMLMatch(spanish, english)).isFalse();

        spanish = MATHML_CONTENT + " not mathml";
        assertThat(this.command.isMathMLMatch(spanish, english)).isFalse();
    }

    // ------------------------------------------------------------------------

    private void initSynFolder() {
        try {
            itemSyncDir = Files.createTempDirectory("test");
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    private void initMathMLData() throws IOException {
        Files.write(this.itemSyncDir.resolve(EQUATION_PNG), "fake png data".getBytes());
        Files.write(this.itemSyncDir.resolve(EQUATION_MATH_ML), MATHML_CONTENT.getBytes());
    }

    private void initImageResources() {
        ItemImageResource imageResource = new ItemImageResource();
        imageResource.setId("1");
        imageResource.setProductionFile(new Attachment(EQUATION_PNG, new Date(), SECTION_IMAGES));
        this.imageResources = Arrays.asList(imageResource);
    }
}