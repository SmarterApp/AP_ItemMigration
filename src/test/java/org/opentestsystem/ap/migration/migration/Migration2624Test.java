package org.opentestsystem.ap.migration.migration;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.runners.MockitoJUnitRunner;
import org.opentestsystem.ap.common.datastore.DataStoreAttachmentManager;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.common.datastore.DataStoreUtility;
import org.opentestsystem.ap.common.datastore.entity.ItemEntity;
import org.opentestsystem.ap.common.gitlab.GitLabSyncManager;
import org.opentestsystem.ap.common.management.ItemManagerEventProducer;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.model.TiItem;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.opentestsystem.ap.common.saaif.metadata.SmarterAppMetadata;
import org.opentestsystem.ap.migration.ApplicationDependencyProvider;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.model.ImportItem;
import org.opentestsystem.ap.migration.model.ItemProps;
import org.opentestsystem.ap.migration.util.MigrationFileUtil;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Matchers.isA;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

@RunWith(MockitoJUnitRunner.class)
public class Migration2624Test {
    private static final String sampleStemContent = "<p style=\"\">Mrs. Palmer’s class also needs <span id=\"item_29136_TAG_17\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"1\"></span>sandwiches<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_17\" data-tag-boundary=\"end\"></span> for the <span id=\"item_29136_TAG_18\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"2\"></span>field trip<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_18\" data-tag-boundary=\"end\"></span>.</p><p style=\"\">&#xA0;</p><p style=\"font-weight:bold; \"><span id=\"item_29136_TAG_16_BEGIN\">Table</span> 2. <span id=\"item_29136_TAG_19\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"1\"></span>Sandwiches<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_19\" data-tag-boundary=\"end\"></span> for Mrs. Palmer’s <span id=\"item_29136_TAG_5_BEGIN\">Class</span></p><p style=\"\">&#xA0;</p><div align=\"left\"><table class=\"newtable\" id=\"item_29136_Table5\" style=\"width:22.0002em; border-spacing:0;\" cellpadding=\"0\" cellspacing=\"0\"><colgroup style=\"width:8.1252em; \" /><colgroup style=\"width:13.8750em; \" /><tbody><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-top:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; font-weight:bold; \"><span id=\"item_29136_TAG_6_BEGIN\">Type</span> of <span id=\"item_29136_TAG_10_BEGIN\"><span id=\"item_29136_TAG_10\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"1\"></span>Sandwich<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_10\" data-tag-boundary=\"end\"></span></span></p></td><td style=\"vertical-align:middle; padding:0.2292em;  border:0.06em solid #000000;\"><p style=\"text-align:center; font-weight:bold; \">How Many Are <span id=\"item_29136_TAG_11_BEGIN\">Needed</span></p></td></tr><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span id=\"item_29136_TAG_7_BEGIN\">Cheese</span></p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span id=\"item_29136_TAG_12_BEGIN\">10</span></p></td></tr><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span id=\"item_29136_TAG_8_BEGIN\">Ham</span></p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span id=\"item_29136_TAG_13_BEGIN\">12</span></p></td></tr><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span id=\"item_29136_TAG_9_BEGIN\">Turkey</span></p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span id=\"item_29136_TAG_14_BEGIN\">8</span></p></td></tr></tbody></table></div><p style=\"\">&#xA0;</p><p style=\"\">Use the information in <span style=\"font-weight:bold; \">Table 1 Sandwiches</span> and <span style=\"font-weight:bold; \">Table 2 Sandwiches for Mrs. Palmer’s Class.</span></p><p style=\"\">&#xA0;</p><p style=\"\"><span id=\"item_29136_TAG_20\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"3\"></span>Enter<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_20\" data-tag-boundary=\"end\"></span> how many of each <span id=\"item_29136_TAG_21\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"4\"></span>type<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_21\" data-tag-boundary=\"end\"></span> of sandwich are needed for the field trip and find the total number of <span id=\"item_29136_TAG_15_BEGIN\"><span id=\"item_29136_TAG_15\" class=\"its-tag\" data-tag=\"word\" data-tag-boundary=\"start\" data-word-index=\"1\"></span>sandwiches.<span class=\"its-tag\" data-tag-ref=\"item_29136_TAG_15\" data-tag-boundary=\"end\"></span></span></p><div align=\"left\"><table class=\"tableItem\" style=\"width:21.166800000000002em; border-spacing:0;\" cellpadding=\"0\" cellspacing=\"0\"><colgroup style=\"width:13.8750em; \" /><colgroup style=\"width:7.2918em; \" /><thead><tr><th data-its-identifier=\"col0\" style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-top:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; font-weight:bold; \">Question</p></th><th data-its-identifier=\"col1\" style=\"vertical-align:middle; padding:0.2292em;  border:0.06em solid #000000;\"><p style=\"text-align:center; font-weight:bold; \">Answer</p></th></tr></thead><tbody><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"\">How many <span style=\"font-weight:bold; \">Cheese</span> sandwiches are needed?</p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"numericOnly\">_</span></p></td></tr><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"\">How many <span style=\"font-weight:bold; \">Ham</span> sandwiches are needed?</p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"numericOnly\">_</span></p></td></tr><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"\">How many <span style=\"font-weight:bold; \">Turkey</span> sandwiches are needed?</p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"numericOnly\">_</span></p></td></tr><tr><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"\">What is the total number of sandwiches needed?</p></td><td style=\"vertical-align:middle; padding:0.2292em;  border-left:0.06em solid #000000; border-right:0.06em solid #000000; border-bottom:0.06em solid #000000;\"><p style=\"text-align:center; \"><span data-its-input=\"true\" data-its-validationRule=\"numericOnly\">_</span></p></td></tr></tbody></table></div>";

    @Mock
    private ApplicationProperties applicationProperties;

    @Mock
    private DataStoreDataManager dataManager;

    @Mock
    private ItemManagerEventProducer eventProducer;

    @Mock
    private DataStoreUtility dataStoreUtility;

    @Mock
    private DataStoreAttachmentManager dataStoreAttachmentManager;

    @Mock
    private MigrationFileUtil migrationFileUtil;

    @Mock
    private GitLabSyncManager gitLabSyncManager;

    @Mock
    private ApplicationDependencyProvider applicationDependencyProvider;

    private Migration2624 migration;

    @Before
    public void setUp() {
        when(applicationDependencyProvider.getMigrationFileUtil()).thenReturn(migrationFileUtil);
        when(applicationDependencyProvider.getItemBankSyncManager()).thenReturn(gitLabSyncManager);
        migration = new Migration2624(applicationProperties, dataManager, eventProducer, dataStoreUtility, dataStoreAttachmentManager, applicationDependencyProvider);
    }

    @Test
    public void shouldRemoveTiTableFromSnippet() throws IOException {
        ItemRelease itemRelease = new ItemRelease();
        ItemRelease.Item item = new ItemRelease.Item();
        ItemRelease.Item.Content content = new ItemRelease.Item.Content();
        content.setStem(sampleStemContent);
        content.setLanguage(ItemConstants.ItemLanguage.LANG_ENU);
        item.getContent().add(content);
        itemRelease.setItem(item);

        TiItem tiItem = new TiItem("123");

        ItemEntity entity = new ItemEntity("123", "master");
        entity.setItemJson(tiItem);

        ImportItem importItem = new ImportItem();
        ItemProps itemProps = new ItemProps();
        SmarterAppMetadata metadata = new SmarterAppMetadata();
        metadata.setSubject("math");

        importItem.setItemProps(itemProps);
        importItem.setItemRelease(itemRelease);
        importItem.setSmarterAppMetadata(metadata);
        importItem.setExpandedImportItemPath(Files.createTempDirectory("tes"));
        importItem.setItemImportSourcePath(Files.createTempDirectory("testSrc"));

        when(migrationFileUtil.getImportItem(entity)).thenReturn(Optional.of(importItem));

        ItemEntity migratedEntity = migration.migrateEntity(entity);

        TiItem migratedItem = (TiItem) migratedEntity.getItemJson();
        assertThat(migratedItem.getCore().getEn().getPrompt()).isNotBlank();

        verify(gitLabSyncManager).syncAttachmentsToDataStore(isA(String.class), isA(String.class), isA(Path.class));
    }
}