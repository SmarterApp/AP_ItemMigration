package org.opentestsystem.ap.migration.migration;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.runners.MockitoJUnitRunner;
import org.opentestsystem.ap.common.datastore.DataStoreAttachmentManager;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.common.datastore.DataStoreItemManager;
import org.opentestsystem.ap.common.datastore.DataStoreUtility;
import org.opentestsystem.ap.common.datastore.entity.ItemEntity;
import org.opentestsystem.ap.common.model.GiItem;
import org.opentestsystem.ap.common.model.MiItem;
import org.opentestsystem.ap.common.model.ModelConstants;
import org.opentestsystem.ap.common.model.TutItem;
import org.opentestsystem.ap.common.saaif.mapper.model.SkipMigration;
import org.opentestsystem.ap.migration.ApplicationProperties;
import org.opentestsystem.ap.migration.model.MigrationContext;
import org.opentestsystem.ap.migration.util.ApplicationDependencyProvider;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.Assert.fail;

@RunWith(MockitoJUnitRunner.class)
public class Migration2778Test {

    @Mock
    private ApplicationProperties applicationProperties;

    @Mock
    private DataStoreDataManager dataManager;

    @Mock
    private DataStoreItemManager dataStoreItemManager;

    @Mock
    private DataStoreUtility dataStoreUtility;

    @Mock
    private DataStoreAttachmentManager dataStoreAttachmentManager;

    @Mock
    private ApplicationDependencyProvider applicationDependencyProvider;

    private ItemEntity entity;

    private Migration2778 migration;

    @Before
    public void setup() {
        migration = new Migration2778(
            applicationDependencyProvider,
            applicationProperties,
            dataManager,
            dataStoreItemManager,
            dataStoreUtility,
            dataStoreAttachmentManager);
    }

    @Test
    public void itShouldNotMigrateBranchBecauseBranchIsNotMaster() {
        entity = new ItemEntity();
        entity.setBranchName(ModelConstants.Section.SECTION_CORE);
        assertThat(migration.shouldMigrateBranch(entity)).isFalse();
    }

    @Test
    public void itShouldMigrateBranchBecauseBranchIsMaster() {
        entity = new ItemEntity();
        entity.setBranchName(ModelConstants.BranchNames.BRANCH_MASTER);
        assertThat(migration.shouldMigrateBranch(entity)).isTrue();
    }

    @Test
    public void itShouldNotMigrateEntityBecauseItemIsNotGIorMI() {
        TutItem tutorial = new TutItem("123");

        entity = new ItemEntity();
        entity.setBranchName(ModelConstants.BranchNames.BRANCH_MASTER);
        entity.setItemJson(tutorial);

        try {
            MigrationContext migrationContext = new MigrationContext("",new ApplicationProperties.MigrationDefinition());
            migration.migrateEntity(entity, migrationContext);
            fail("Expected SkipMigration exception to be thrown");
        } catch (SkipMigration e) {
            assertThat(e.getMessage()).isEqualTo("item is not GI or MI");
        }
    }

    @Test
    public void itShouldMigrateBranchBecauseItIsGI() {
        entity = new ItemEntity();
        entity.setBranchName(ModelConstants.BranchNames.BRANCH_MASTER);
        entity.setItemJson(new GiItem("123"));
        MigrationContext migrationContext = new MigrationContext("",new ApplicationProperties.MigrationDefinition());
        ItemEntity migratedEntity = migration.migrateEntity(entity, migrationContext);
        assertThat(migratedEntity).isEqualTo(entity);
    }

    @Test
    public void itShouldMigrateBranchBecauseItIsMI() {
        entity = new ItemEntity();
        entity.setBranchName(ModelConstants.BranchNames.BRANCH_MASTER);
        entity.setItemJson(new MiItem("123"));
        MigrationContext migrationContext = new MigrationContext("",new ApplicationProperties.MigrationDefinition());
        ItemEntity migratedEntity = migration.migrateEntity(entity, migrationContext);
        assertThat(migratedEntity).isEqualTo(entity);
    }
}