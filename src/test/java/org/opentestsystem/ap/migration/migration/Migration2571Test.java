package org.opentestsystem.ap.migration.migration;

import org.apache.commons.lang3.StringUtils;
import org.junit.Test;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

import static org.assertj.core.api.Assertions.assertThat;

public class Migration2571Test {

    private static final String BRAILLE_NAMING_PATTERN = "^(stim|item|passage)_(\\d+)_enu_([ue][xc][ntl])" +
            "(_transcript)?\\.(brf|prn)$";

    private static final String BRAILLE_NAMING_PATTERN_INVALID = "^(stim|item|passage)_(\\d+)_enu_(\\w+)_([ue][xc][ntl])" +
            "(_transcript)?\\.(brf|prn)$";

    private static final Pattern BRAILLE_PATTERN = Pattern.compile(BRAILLE_NAMING_PATTERN, Pattern.CASE_INSENSITIVE);

    private static final Pattern BRAILLE_PATTERN_INVALID = Pattern
            .compile(BRAILLE_NAMING_PATTERN_INVALID, Pattern.CASE_INSENSITIVE);


    private static final String FILENAME_VALID = "passage_188_enu_ecn.prn";

    private static final String FILENAME_INVALID = "passage_188_enu_prn_ebae_contracted_nemeth_ecn.prn";
    private static final String FILENAME_INVALID_TRANSCRIPT = "passage_188_enu_prn_ebae_contracted_nemeth_ecn_transcript.prn";

    @Test
    public void testBrailleFileNameFormat() {
        assertThat(this.isInvalid(FILENAME_INVALID)).isTrue();
        assertThat(this.isValid(FILENAME_VALID)).isTrue();
    }

    @Test
    public void testCorrectingInvalidFileName() {
        assertThat(this.isValid(this.correctInvalidFileName(FILENAME_INVALID))).isTrue();
        assertThat(this.isValid(this.correctInvalidFileName(FILENAME_INVALID_TRANSCRIPT))).isTrue();
    }

    private String correctInvalidFileName(String filename) {
        if (isInvalid(filename)) {
            Matcher matcher = BRAILLE_PATTERN_INVALID.matcher(filename);
            if (matcher.find()) {
                if (StringUtils.isNotBlank(matcher.group(5))) {
                    return String.format("%s_%s_enu_%s%s.%s",
                            matcher.group(1), matcher.group(2), matcher.group(4), matcher.group(5), matcher.group(6));
                } else {
                    return String.format("%s_%s_enu_%s.%s",
                            matcher.group(1), matcher.group(2), matcher.group(4), matcher.group(6));
                }
            }
        }
        return filename;
    }

    private boolean isValid(String filename) {
        return BRAILLE_PATTERN.matcher(filename).matches();
    }

    private boolean isInvalid(String filename) {
        return BRAILLE_PATTERN_INVALID.matcher(filename).matches();
    }
}
